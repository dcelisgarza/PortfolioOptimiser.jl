using CSV, TimeSeries, DataFrames, StatsBase, Statistics, LinearAlgebra, Test, Clarabel,
      PortfolioOptimiser

path = joinpath(@__DIR__, "assets/stock_prices.csv")
prices = TimeArray(CSV.File(path); timestamp = :date)
rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "WC" begin
    portfolio = Portfolio(; prices = prices,
                          solvers = PortOptSolver(; name = :Clarabel,
                                                  solver = Clarabel.Optimizer,
                                                  check_sol = (; allow_local = true,
                                                               allow_almost = true),
                                                  params = ["verbose" => false,
                                                            "max_step_fraction" => 0.75]))
    asset_statistics!(portfolio)
    wc_statistics!(portfolio;
                   wc_type = WCType(; box = NormalWC(; seed = 123456789),
                                    ellipse = NormalWC(; seed = 123456789)))

    obj = MinRisk()

    kelly = NoKelly()
    rm = Variance()
    w1 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.007911813464316563, 0.030685102137465003, 0.010505366137937627,
          0.02748375285330022, 0.012276170276064991, 0.033407270362069155,
          3.9681916897466676e-7, 0.13984690156809362, 6.626902694299562e-7,
          1.4125052278009859e-5, 0.287819278544025, 4.2200065479380485e-7,
          3.2968647670955543e-7, 0.1252756033367362, 1.836077877893019e-6,
          0.015083599354026141, 2.2788913848604495e-5, 0.19311714086149775,
          8.33379655093792e-7, 0.11654660648423812]
    @test isapprox(w1.weights, wt)

    rm = WCVariance()
    w2 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.010505262318529992, 0.02765001122550846, 0.005155696156007754,
          0.014740124727828497, 0.0010683067257489488, 0.025331092034852395,
          3.754513874058572e-7, 0.13424546801820622, 1.4866284653090363e-6,
          1.8892933709798838e-5, 0.3078517408243262, 5.63377136447301e-7,
          3.110414525764398e-7, 0.12812721007458797, 1.2279377389265111e-6,
          8.308260892405014e-5, 0.008584743293094763, 0.2075899643656187,
          2.629689746559314e-6, 0.129041810567129]
    @test isapprox(w2.weights, wt, rtol = 0.01)

    rm.wc_set = Ellipse()
    w3 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.007915669821972938, 0.03068369270669364, 0.010505135478940485,
          0.027482428781704014, 0.012274452117648901, 0.03340546407633817,
          1.2177315244956563e-7, 0.13984988504295037, 2.1013243747041726e-7,
          4.845525485577704e-6, 0.2878311185751857, 1.297107786941948e-7,
          1.0113247724226698e-7, 0.12527926477272386, 6.011479012942595e-7,
          0.01508242855901022, 7.863615901943814e-6, 0.19312565954238872,
          2.6930144902294445e-7, 0.11655065818485925]
    @test isapprox(w3.weights, wt, rtol = 5.0e-8)

    kelly.wc_set = Box()
    rm = Variance()
    w4 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.00792065742760887, 0.030668637277270414, 0.010500432216142526,
          0.027472910520011096, 0.012271335324961146, 0.033393094532735,
          1.728880761891034e-6, 0.13984196459803458, 2.902646782469052e-6,
          6.137370884061714e-5, 0.2878082866151491, 1.8463236147379452e-6,
          1.438334441195597e-6, 0.12524860212396854, 7.997518373077627e-6,
          0.015077475176265715, 9.879305759185557e-5, 0.19309419174112602,
          3.645964676816195e-6, 0.11652268601164413]
    @test isapprox(w4.weights, wt)

    rm = WCVariance()
    w5 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.010485323947274642, 0.02763472687903287, 0.0051582579275902185,
          0.01473022995223824, 0.0011034822444609253, 0.025325763023434943,
          4.384456477155093e-7, 0.13424317043556885, 1.7339563285631196e-6,
          2.198250602715775e-5, 0.30785468395078497, 6.580793426480371e-7,
          3.640388686990717e-7, 0.12812714403276232, 1.4335156329910958e-6,
          9.63475507546304e-5, 0.008584326247404458, 0.20759531561665803,
          3.0643263594866353e-6, 0.12903155332382776]
    @test isapprox(w5.weights, wt, rtol = 0.01)

    rm.wc_set = Ellipse()
    w6 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.007916226589806577, 0.030683353666552154, 0.010505103493452348,
          0.027482085756591862, 0.012274304379939873, 0.033405353774195776,
          1.2949192360030685e-7, 0.1398501189005476, 2.2328306518931636e-7,
          5.155542704856279e-6, 0.2878321070798829, 1.3800835011901191e-7,
          1.0762001800582802e-7, 0.1252785892075656, 6.384724293884122e-7,
          0.01508231417350666, 8.374098866207686e-6, 0.19312552617272066,
          2.857488790514639e-7, 0.11654986453900179]
    @test isapprox(w6.weights, wt, rtol = 5.0e-8)

    kelly.wc_set = Ellipse()
    rm = Variance()
    w7 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.007909537856206164, 0.030689718255011864, 0.010506789943790507,
          0.02748676433387746, 0.012277520150601164, 0.033411335407212084,
          2.617989299314997e-8, 0.13984829600681303, 4.4241613330232595e-8,
          9.427135178002876e-7, 0.28782215568808145, 2.820788810518629e-8,
          2.1722025381310856e-8, 0.12528313510020228, 1.219425413700327e-7,
          0.015085349355071985, 1.522506427308343e-6, 0.19312342649980008,
          5.5696001840248274e-8, 0.1165532081934238]
    @test isapprox(w7.weights, wt)

    rm = WCVariance()
    w8 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.010679320316551711, 0.0277269877911594, 0.005180570068271846,
          0.014799058589056642, 0.0007846490313187991, 0.025359575888464433,
          3.220311381073476e-9, 0.13425402283015495, 1.2804994087409802e-8,
          1.6387162692945203e-7, 0.30782743677775776, 4.839546730175031e-9,
          2.662865535949132e-9, 0.12811924110183784, 1.0537599013647173e-8,
          7.606037606538199e-7, 0.008636130253989903, 0.2075345596830514,
          2.262322168737283e-8, 0.12909746650445925]
    @test isapprox(w8.weights, wt, rtol = 0.01)

    rm.wc_set = Ellipse()
    w9 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.00791482165032684, 0.030684584068925397, 0.010505408740941719,
          0.02748303032490451, 0.01227490471740045, 0.03340634007969974,
          1.0633245207374027e-7, 0.13984960370917032, 1.815200585357996e-7,
          4.158002445131335e-6, 0.2878296324112996, 1.1265886843328611e-7,
          8.813709251081197e-8, 0.12528004238693688, 5.210154360396287e-7,
          0.015082839383283163, 6.730952934740394e-6, 0.19312545226638447,
          2.3140924308554563e-7, 0.11655121023219643]
    @test isapprox(w9.weights, wt, rtol = 5.0e-8)

    obj = Utility(; l = l)
    kelly.wc_set = NoWC()
    rm = Variance()
    w10 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [7.522712166957738e-9, 1.5448119639883677e-8, 2.120075985769965e-8,
          1.61439776257853e-8, 0.7741905760954481, 1.5378393929336733e-9,
          0.10998663265848552, 7.410785460525767e-9, 2.2122125905467753e-8,
          6.858051425454793e-9, 6.262958027435835e-9, 1.7618455584080183e-9,
          3.311596620365877e-9, 1.3573889850052232e-9, 3.0261427185003904e-9,
          0.11582254190403514, 7.351479683983548e-8, 8.380950506199412e-9,
          4.173933026031456e-8, 1.1742650472526705e-8]
    @test isapprox(w10.weights, wt)

    rm = WCVariance()
    w11 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [2.805716190890176e-8, 6.088365624069214e-8, 1.0568078151538469e-7,
          6.412319437460625e-8, 0.7874637096101381, 8.77422866291805e-9,
          0.09194225139664124, 2.6192987809704286e-8, 9.665810149369637e-8,
          2.5024890510346207e-8, 2.3372371281176592e-8, 8.255036285355643e-9,
          6.25704011973132e-9, 1.3190093800452873e-8, 6.1985343812035715e-9,
          0.12059116015349544, 1.957546960890278e-6, 2.9194381725999492e-8,
          3.7710143676481466e-7, 4.2328867346495816e-8]
    @test isapprox(w11.weights, wt, rtol = 0.005)

    rm.wc_set = Ellipse()
    w12 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [1.0817131674324131e-8, 2.889834405555976e-8, 4.024221161322655e-8,
          2.4723019415101256e-8, 0.5625967619010117, 3.1853029013843226e-9,
          0.07157115390725362, 1.9261981775340735e-8, 3.007667860789801e-8,
          1.1629547908783714e-8, 1.604168248789888e-8, 2.639035849100641e-9,
          1.915014613885714e-9, 5.690758925535531e-9, 1.8686617382003593e-9,
          0.14787356584614542, 0.17030634430559083, 1.9681883224143102e-8,
          0.04765193490126016, 2.2467483664152168e-8]
    @test isapprox(w12.weights, wt, rtol = 0.001)

    kelly.wc_set = Box()
    rm = Variance()
    w13 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [5.252194452079515e-9, 1.031535486427643e-8, 9.455445002828933e-9,
          4.0132093122963755e-9, 0.5819241901850066, 6.270895459420635e-10,
          2.0561436069527382e-9, 6.707564451760214e-9, 7.865563976161287e-9,
          4.174500901517634e-9, 1.0991695319655359e-8, 2.1907872384482647e-10,
          1.1231728021597677e-10, 2.5405249292978275e-9, 1.811392469557399e-10,
          1.0750087766165246e-8, 0.4180755819595816, 1.2097725638064922e-8,
          1.273857094095548e-7, 1.3110067439258625e-8]
    @test isapprox(w13.weights, wt)

    rm = WCVariance()
    w14 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [7.450617561203435e-8, 1.6917707192315162e-7, 1.567471389219165e-7,
          5.3660427700111614e-8, 0.5520776394586291, 1.841614636887493e-8,
          2.9069631640138387e-8, 9.268404816032403e-8, 1.0485330098663648e-7,
          5.4460570484930626e-8, 1.8959018987776546e-7, 1.1836606199162978e-8,
          6.9505032772479036e-9, 3.673765106194884e-8, 8.326868451375697e-9,
          1.46635215938837e-7, 0.4479156448057863, 2.156962161572903e-7,
          5.092622257136216e-6, 2.5376556477626486e-7]
    @test isapprox(w14.weights, wt, rtol = 0.001)

    rm.wc_set = Ellipse()
    w15 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [8.944699665874712e-9, 2.4866016687209537e-8, 1.8056975027233465e-8,
          6.701055880721176e-9, 0.3997543530600884, 2.28279574922472e-9,
          3.235792020528003e-9, 2.9551515433410007e-8, 9.862417196022293e-9,
          7.666562367860835e-9, 0.032978164250364414, 1.2731123003899245e-9,
          7.278461891769551e-10, 5.29152538961053e-9, 8.767298048625151e-10,
          3.906026526832658e-8, 0.4425967756222856, 2.594790000012218e-7,
          0.12467021234820054, 7.684275213276779e-8]
    @test isapprox(w15.weights, wt, rtol = 0.001)

    kelly.wc_set = Ellipse()
    rm = Variance()
    w16 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.004693559535706938, 0.03169836414352631, 0.012129963693487978,
          0.02810771359920274, 0.01892932696746519, 0.023655483430201466,
          1.4163700577931323e-8, 0.13876997110144496, 2.32347448400989e-8,
          9.068461506432257e-7, 0.2889430629754584, 1.2659952049090117e-8,
          9.679831510232964e-9, 0.12088003598788585, 3.857204453276775e-8,
          0.01705983030744189, 0.003165472335153956, 0.1950028925981883,
          3.0519011679565134e-8, 0.11696328764940013]
    @test isapprox(w16.weights, wt, rtol = 1.0e-5)

    rm = WCVariance()
    w17 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.004707791908335483, 0.03168011994608607, 0.012095944726982897,
          0.02803363059967011, 0.018858414233725893, 0.02360951845095837,
          4.062695091533421e-10, 0.13873732502020755, 7.218091124516795e-10,
          4.018727224148649e-8, 0.2890603349686695, 4.1736222559824104e-10,
          2.9349382715563125e-10, 0.12089400398467261, 1.1087628592860438e-9,
          0.016965121620385774, 0.0032370161940927407, 0.19508381163882427,
          9.295988249096634e-10, 0.1170369226428201]
    @test isapprox(w17.weights, wt, rtol = 0.0001)

    rm.wc_set = Ellipse()
    w18 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.00470793943460317, 0.03169648179413269, 0.012124808282586247,
          0.028106341262349902, 0.018903442332804023, 0.02369550390238433,
          8.921232449396263e-10, 0.13877483349713424, 1.4822841679084963e-9,
          6.006577482922801e-8, 0.2889391999126842, 7.991192476634082e-10,
          6.07022442605008e-10, 0.12090015499880688, 2.432451838638286e-9,
          0.01705249593429949, 0.0031368731795578695, 0.19499783747523122,
          1.948624861428987e-9, 0.11696401976602508]
    @test isapprox(w18.weights, wt, rtol = 1.0e-5)

    obj = Sharpe(; rf = rf)
    kelly.wc_set = NoWC()
    rm = Variance()
    w19 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [3.047507335849635e-9, 8.756351501197453e-9, 1.1835685181243964e-8,
          7.037371926099174e-9, 0.5180580294619301, 8.497321646551327e-10,
          0.06365095465210924, 7.070973236709339e-9, 6.793752068352707e-9,
          3.4065880371682496e-9, 5.6002969155450796e-9, 7.438892595740676e-10,
          5.560654963716985e-10, 1.6569379477120201e-9, 5.015001520451044e-10,
          0.14326778797194253, 0.19649629723396791, 6.666237166621602e-9,
          0.07852685910002084, 7.05714096151307e-9]
    @test isapprox(w19.weights, wt)

    rm = WCVariance()
    w20 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [3.3621205847657384e-7, 0.00047928875360331546, 1.596970268705196e-5,
          3.636598085305885e-6, 0.26504321048408636, 3.538501923380916e-8,
          0.011606508772905262, 0.06897635854614306, 5.969812612714506e-7,
          5.781568169650305e-7, 0.15979898071298898, 2.253300016859855e-8,
          1.5647234135673777e-8, 1.2734755910032396e-7, 1.659123047740417e-8,
          0.07256620154525836, 0.20133186829049246, 0.09894665144160442, 0.088430221605468,
          0.03279937469249761]
    @test isapprox(w20.weights, wt, rtol = 5.0e-7)

    rm.wc_set = Ellipse()
    w21 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [4.2946250882767236e-8, 0.007779372264384392, 0.0038665286561550094,
          0.00275518281348177, 0.25098772340532666, 1.0219966658024616e-8,
          0.023159635856346953, 0.08562691375753118, 5.4803347153674394e-8,
          5.987111869575649e-8, 0.16235440246006932, 6.627549917259505e-9,
          4.459500563865521e-9, 2.80217598747013e-8, 4.846155883530029e-9,
          0.08334181894446731, 0.16534769031320073, 0.10482650694977165,
          0.07552949095156034, 0.03442452183205518]
    @test isapprox(w21.weights, wt)

    kelly.wc_set = Box()
    rm = Variance()
    w22 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [5.0260866430131225e-8, 7.119674418783426e-8, 7.979707436661497e-8,
          3.922115090997502e-8, 0.9999986077048437, 1.3137249458091009e-8,
          2.4140354678373507e-8, 4.043458388799476e-8, 6.183081755849597e-8,
          3.478750939861157e-8, 5.0358773852720606e-8, 8.837405865833694e-9,
          4.805004947266459e-9, 2.4259888104973717e-8, 5.8438799761735735e-9,
          6.054685340139919e-8, 5.419856298414435e-7, 5.794577740335561e-8,
          1.4903586601474772e-7, 7.38697260168698e-8]
    @test isapprox(w22.weights, wt)

    rm = WCVariance()
    w23 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [4.134376883103088e-9, 6.692232302789271e-9, 6.939451884609115e-9,
          3.1931905745108186e-9, 0.7014137833583913, 1.0659266277340834e-9,
          1.8841480916531712e-9, 3.8761069928800045e-9, 5.471997267071932e-9,
          2.994922949893036e-9, 5.391044996826766e-9, 6.976286386366531e-10,
          3.8081489124213455e-10, 2.051478042483751e-9, 4.6279350029440195e-10,
          5.949184598084508e-9, 0.29858611910198923, 6.19083319564003e-9,
          3.2563711224278856e-8, 7.59977675777654e-9]
    @test isapprox(w23.weights, wt)

    rm.wc_set = Ellipse()
    w24 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [2.160786757582722e-9, 3.4464271822396075e-9, 3.4987659684056767e-9,
          1.7081605528101048e-9, 0.6864102151609224, 5.973736490533407e-10,
          1.0355105545596239e-9, 2.138171801792582e-9, 2.8598296415805214e-9,
          1.6362253946551959e-9, 2.935841543274493e-9, 3.899975866294733e-10,
          2.1591263408946286e-10, 1.1398045848967056e-9, 2.610623711529985e-10,
          3.233299946282687e-9, 0.31358973603071566, 3.31069256254102e-9,
          1.4361096698429417e-8, 3.879402692921536e-9]
    @test isapprox(w24.weights, wt, rtol = 5.0e-7)

    kelly.wc_set = Ellipse()
    rm = Variance()
    w25 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.03668699478582806, 0.04199403436794092, 0.03158083933533834,
          0.030223424091804413, 0.030963950682207125, 0.05092107388691887,
          0.00539237446272562, 0.12741042422900892, 0.01520026272558982,
          0.03191251305819219, 0.199628293321302, 0.007864727315155796,
          0.004658985994392003, 0.08046868727603212, 0.01464008883272933,
          0.030923246980974105, 0.03998219832902477, 0.1239050047200327,
          0.024618179504698936, 0.07102469610010399]
    @test isapprox(w25.weights, wt, rtol = 5.0e-5)

    rm = WCVariance()
    w26 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.04434667823319208, 0.046528228046693966, 0.0398277692972994,
          0.03688552234747465, 0.039288129870342636, 0.05223117549040448,
          0.018164941005962994, 0.10233495894273649, 0.029037726930288294,
          0.039631504687075124, 0.14065630647782434, 0.022548389068502876,
          0.0173301860528932, 0.06829461148034699, 0.025530325462921066,
          0.03742568155157581, 0.04570210759631535, 0.09488906494763243, 0.0360973280508274,
          0.0632493644596905]
    @test isapprox(w26.weights, wt, rtol = 0.0005)

    rm.wc_set = Ellipse()
    w27 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.033899981174270725, 0.041522699517496243, 0.029713306845669925,
          0.030088582391661716, 0.029218641360507024, 0.05051625097823812,
          0.0009132432077065283, 0.1283973710563001, 0.009746770311749283,
          0.030107578018352087, 0.21416508196173528, 0.001772290252427619,
          0.0003861400923800053, 0.08742390229570096, 0.011297279192536725,
          0.030547843147737917, 0.03829092435932253, 0.1349402895583896,
          0.019913279929698966, 0.07713854434811851]
    @test isapprox(w27.weights, wt, rtol = 0.0001)

    obj = MaxRet()
    kelly.wc_set = NoWC()
    rm = Variance()
    w28 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [2.2425872064182503e-8, 2.3869345714744183e-8, 3.0249972071127925e-8,
          2.7441036408966832e-8, 2.674016472879105e-6, 1.1117945427350462e-8,
          0.9999969549278999, 1.6603745200809882e-8, 2.5223224538501096e-8,
          1.8088400365786554e-8, 1.61723807198772e-8, 1.1616638624454757e-8,
          8.681387036441865e-9, 1.377196283532058e-8, 8.992921448080973e-9,
          4.0392434474846235e-8, 3.1600448886835504e-8, 1.7426103712222823e-8,
          2.6166436896960802e-8, 2.1215370935214236e-8]
    @test isapprox(w28.weights, wt)

    rm = WCVariance()
    w29 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [6.989037894153361e-8, 7.480538210565656e-8, 9.691293469005913e-8,
          8.678037209210843e-8, 8.83780308684425e-6, 3.405815640181256e-8, 0.99998999333959,
          5.0910247622783476e-8, 7.956894827168171e-8, 5.5670422511961646e-8,
          4.943917760140057e-8, 3.572433741167029e-8, 2.7230914952084987e-8,
          4.200273371512125e-8, 2.7981881704772375e-8, 1.3369440448455757e-7,
          1.0195753500768141e-7, 5.343621687414818e-8, 8.291247353947803e-8,
          6.58808052003012e-8]
    @test isapprox(w29.weights, wt)

    rm.wc_set = Ellipse()
    w30 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [7.557373043328773e-10, 8.076782220927106e-10, 1.0443145369507127e-9,
          9.359408251112705e-10, 1.0872408625408755e-7, 3.781875331915266e-10,
          0.999999878579857, 5.560321337955898e-10, 8.594596265633233e-10,
          6.066737928742431e-10, 5.405772841878036e-10, 3.9671164925883545e-10,
          3.045445880537671e-10, 4.627780252852682e-10, 3.125443989397034e-10,
          1.4463379951285884e-9, 1.0983103441793478e-9, 5.825488309417498e-10,
          8.944332827304902e-10, 7.132463682764463e-10]
    @test isapprox(w30.weights, wt)

    kelly.wc_set = Box()
    rm = Variance()
    w31 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [4.204205203542449e-8, 4.52151914455539e-8, 5.659006380294785e-8,
          3.514878006645271e-8, 0.9999993010578087, 1.5765086265663477e-8,
          2.7221730459829723e-8, 2.8333312807231666e-8, 4.0442400780506775e-8,
          2.8205642322983483e-8, 3.015402047164297e-8, 1.3622177335174017e-8,
          8.610125010959476e-9, 2.1881581304089744e-8, 1.0054344901923858e-8,
          3.857715271568933e-8, 1.201866393126026e-7, 3.337383016337279e-8,
          5.928283995021941e-8, 4.42352202098176e-8]
    @test isapprox(w31.weights, wt)

    rm = WCVariance()
    w32 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [9.349443308972116e-8, 1.0239636651227387e-7, 1.233364801228975e-7,
          7.86882322009486e-8, 0.999998459470907, 3.374223076459609e-8,
          6.050116124661095e-8, 6.51235976687806e-8, 9.245824168447669e-8,
          6.423360525571307e-8, 7.082470644200628e-8, 2.840564261364499e-8,
          1.7518365513254118e-8, 4.905313270919211e-8, 2.0460696085804017e-8,
          8.88320134284753e-8, 2.388667481929771e-7, 7.830567654867343e-8,
          1.3326595908949505e-7, 1.0102180385208182e-7]
    @test isapprox(w32.weights, wt)

    rm.wc_set = Ellipse()
    w33 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [6.951776791650045e-10, 7.623338151759487e-10, 9.242434324077375e-10,
          5.888794418446168e-10, 0.9999999883860969, 2.546616267443753e-10,
          4.611257640454363e-10, 4.83346835194399e-10, 6.893058462042585e-10,
          4.79488007836693e-10, 5.218722830698115e-10, 2.1865601988791256e-10,
          1.3678932465370838e-10, 3.652334940493917e-10, 1.5880646578070034e-10,
          6.65386630333166e-10, 1.878633599620097e-9, 5.782505869920645e-10,
          1.0015839924968695e-9, 7.501281605435445e-10]
    @test isapprox(w33.weights, wt)

    kelly.wc_set = Ellipse()
    rm = Variance()
    w34 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.004673507042573548, 0.03170121824101275, 0.01213716074983467,
          0.028109772046531013, 0.01896480998262944, 0.023601128417283394,
          1.3751619568813637e-8, 0.1387634338016991, 2.3003240383071667e-8,
          9.093159089332627e-7, 0.2889485204734536, 1.2276165285978352e-8,
          9.266122498606984e-9, 0.12085297997683866, 3.8187058574230424e-8,
          0.01706996047179656, 0.003203549288618823, 0.19501021778744967,
          3.033277729523375e-8, 0.11696270558738632]
    @test isapprox(w34.weights, wt, rtol = 1.0e-5)

    rm = WCVariance()
    w35 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.004673537976966748, 0.031701195445288786, 0.012137146091925163,
          0.02810975710228726, 0.018964798825330857, 0.02360110244926761,
          1.5311407407456336e-8, 0.13876342534330915, 2.545705564449862e-8,
          1.0145275795541222e-6, 0.2889485043788008, 1.3594041442615469e-8,
          1.0339386850279656e-8, 0.12085294737119615, 4.2344602564562274e-8,
          0.0170699489104224, 0.003203622706898777, 0.1950101843139078,
          3.3499259525636553e-8, 0.11696267401106561]
    @test isapprox(w35.weights, wt, rtol = 1.0e-5)

    rm.wc_set = Ellipse()
    w36 = optimise!(portfolio, Trad(; rm = rm, obj = obj, kelly = kelly))
    wt = [0.004673244817190372, 0.03170139396261079, 0.012137270934126525,
          0.028109884440479575, 0.018964905446944652, 0.023601322132116985,
          2.3690055506863073e-9, 0.1387634986487497, 3.872188777363404e-9,
          1.5339587504398632e-7, 0.288948634807124, 2.080972367542935e-9,
          1.5953934172609717e-9, 0.12085322415240292, 6.4846917818404995e-9,
          0.01707004331543968, 0.0032029825571973755, 0.1950104752320347,
          5.056451116475305e-9, 0.11696294469900465]
    @test isapprox(w36.weights, wt, rtol = 1.0e-5)
end
