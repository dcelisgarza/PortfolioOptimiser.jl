using CSV, TimeSeries, DataFrames, StatsBase, Statistics, LinearAlgebra, Test,
      PortfolioOptimiser

assets_path = joinpath(@__DIR__, "assets/stock_prices.csv")
factors_path = joinpath(@__DIR__, "assets/factor_prices.csv")
prices_assets = TimeArray(CSV.File(assets_path); timestamp = :date)
prices_factors = TimeArray(CSV.File(factors_path); timestamp = :date)

rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "Black Litterman" begin
    portfolio = Portfolio(; prices = prices_assets, f_prices = prices_factors)

    asset_sets = DataFrame("Asset" => portfolio.assets,
                           "PDBHT" => [1, 2, 1, 1, 1, 3, 2, 2, 3, 3, 3, 4, 4, 3, 3, 4, 2, 2,
                                       3, 1],
                           "SPDBHT" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 3, 3, 2, 3, 3, 3, 3, 1,
                                        4, 2, 1],
                           "Pward" => [1, 1, 1, 1, 1, 2, 3, 2, 2, 2, 2, 4, 4, 2, 3, 4, 1, 2,
                                       2, 1],
                           "SPward" => [1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 4, 3, 2, 2, 3, 1,
                                        2, 2, 1],
                           "G2DBHT" => [1, 2, 1, 1, 1, 3, 2, 3, 4, 3, 4, 3, 3, 4, 4, 3, 2,
                                        3, 4, 1],
                           "G2ward" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 2, 4, 2, 3, 3, 3, 2, 1,
                                        4, 2, 2])
    views_assets = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           false],
                             "Type" => ["Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Asset"],
                             "Set" => ["", "", "", "", "", "", "", "", "", "", "", "",
                                       "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT",
                                       "Pward", "Pward", "Pward", "Pward", "SPward",
                                       "SPward", ""],
                             "Position" => ["GE", "SBUX", "BABA", "SHLD", "FB", "WMT",
                                            "UAA", "XOM", "UAA", "AMD", "BBY", "FB", 1, 3,
                                            4, 2, 1, 3, 1, 3, 2, 1, 3, 2, "GOOG"],
                             "Sign" => [">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">="],
                             "Return" => [0.3, -0.2, 2.3, -0.7, 0.17, -0.11, 0.13, -0.23,
                                          0.5, -0.37, 0.23, 5.1, 0.27, -0.31, 0.41, -0.19,
                                          0.03, -0.29, 0.71, -0.41, 0.61, -0.019, 1.7, -2.3,
                                          0.69],
                             "Relative_Type" => ["", "", "", "", "Asset", "Asset", "Asset",
                                                 "Asset", "Subset", "Subset", "Subset",
                                                 "Subset", "", "", "", "", "Asset", "Asset",
                                                 "Asset", "Asset", "Subset", "Subset",
                                                 "Subset", "Subset", ""],
                             "Relative_Position" => ["", "", "", "", "GOOG", "AMD", "MA",
                                                     "BAC", 3, 2, 4, 2, "", "", "", "",
                                                     "AAPL", "GE", "PFE", "RRC", 3, 3, 2, 3,
                                                     ""],
                             "Relative_Set" => ["", "", "", "", "", "", "", "", "PDBHT",
                                                "PDBHT", "Pward", "Pward", "", "", "", "",
                                                "", "", "", "", "PDBHT", "Pward", "SPward",
                                                "Pward", ""])

    P, Q = asset_views(views_assets, asset_sets)

    bl_type = BLType(; delta = nothing)
    asset_statistics!(portfolio)
    black_litterman_statistics!(portfolio; P = P, Q = Q, bl_type = bl_type)

    bl_mut = [0.8315340191495042, 0.4945628236835609, 1.7159629401277585,
              1.0416894456593815, 0.6314667966703715, -0.20757822771896367,
              0.42884227536459296, 0.09224013591125971, -0.5952224981615988,
              -0.5328986447555261, -0.31314811871160286, 0.18463792875828738,
              0.40915398904129363, -0.5416953045872718, -0.5049425658370765,
              0.37614522093398645, 0.13578243600216894, -0.1006358224753161,
              -0.5672244129668248, 0.005587508359887028]
    bl_covt = reshape([0.00021008255252989567, 9.80719618642883e-5, 0.00014082908567946293,
                       0.0001182374909141455, 0.00015844390570223703, 6.20415912590239e-5,
                       8.225897171845311e-5, 4.1790589865286584e-5, 9.059578468807845e-5,
                       7.16761492698751e-5, 4.032122885587511e-5, 0.00010232427112004749,
                       3.5842342584471784e-5, 5.3340000288239614e-5, 2.449681502864549e-5,
                       5.009319527400259e-5, 9.855513889720962e-5, 5.896201914444012e-5,
                       7.893899674559978e-5, 8.309615006406581e-5, 9.80719618642883e-5,
                       0.00021162581037800714, 0.00010918355839011303, 9.46211724151634e-5,
                       0.00010731797543543672, 5.819629526680374e-5, 0.00013025274055683783,
                       4.550947218093704e-5, 9.434587115279329e-5, 7.589676853990521e-5,
                       4.180160939117253e-5, 9.136264298596868e-5, 7.145274907967866e-5,
                       5.894409490898287e-5, 5.4148554331350615e-5, 7.434767187535601e-5,
                       9.26087447119215e-5, 5.098200699940018e-5, 8.571578189388688e-5,
                       7.164341154601614e-5, 0.00014082908567946293, 0.00010918355839011303,
                       0.0002573380149266721, 0.00011934634285606628, 0.0001533770061180058,
                       6.706671382419828e-5, 0.0001170975334376465, 3.8658857501515976e-5,
                       9.449448796659433e-5, 7.614735284433617e-5, 3.901252996174615e-5,
                       0.00013795480216614086, 5.835521433661858e-5, 5.2496942766543964e-5,
                       4.339964646487828e-5, 5.64674198400459e-5, 0.00010169675846289593,
                       5.4271664241198255e-5, 8.136182976094078e-5, 8.804054585994111e-5,
                       0.0001182374909141455, 9.46211724151634e-5, 0.00011934634285606628,
                       0.0004008077171526529, 0.00013259900955581738, 6.51219379664725e-5,
                       0.00020069084205797497, 3.4654137226873145e-5, 9.788210160647198e-5,
                       8.157514541837106e-5, 2.8584673786818277e-5, 0.00011093805047275677,
                       0.00010046649151045865, 5.633319789513233e-5, 9.640377176467351e-5,
                       7.791944508596258e-5, 0.0001009506423911739, 5.224622997518834e-5,
                       8.448861671887751e-5, 6.915257063261048e-5, 0.00015844390570223703,
                       0.00010731797543543672, 0.0001533770061180058,
                       0.00013259900955581738, 0.0003313175449413421, 5.1652696406059975e-5,
                       0.00012078522849302118, 3.6817514990980385e-5, 8.816339362649052e-5,
                       6.596914273008957e-5, 3.729904390392456e-5, 0.00011920443213491239,
                       1.9434887981866837e-5, 5.122463295066254e-5, 7.752300372527983e-5,
                       5.711672670998639e-5, 0.0001045151533625324, 4.647321171914114e-5,
                       7.525145216929436e-5, 9.988742986643824e-5, 6.20415912590239e-5,
                       5.819629526680374e-5, 6.706671382419828e-5, 6.51219379664725e-5,
                       5.1652696406059975e-5, 0.0001791519215285957, 9.457602525288688e-5,
                       3.82970252941279e-5, 9.964722815366168e-5, 8.682510186523052e-5,
                       5.278964088169284e-5, 0.00010674626053620905, 0.0001151851632467459,
                       6.948724266262221e-5, 0.00010070782815312086, 4.771810306698167e-5,
                       6.472520860458046e-5, 5.61824673338327e-5, 9.131329592695117e-5,
                       6.142590082211738e-5, 8.225897171845311e-5, 0.00013025274055683783,
                       0.0001170975334376465, 0.00020069084205797497,
                       0.00012078522849302118, 9.457602525288688e-5, 0.0016485277656449599,
                       4.519865071383538e-5, 0.00016774256148619962, 0.00013860200813484136,
                       6.448575831952189e-5, 0.00010583436864531165, 0.00014003499066700457,
                       8.969628005119778e-5, 0.00024081106289907701, 0.00012003166381872516,
                       0.00013060309394790013, 7.416253714990298e-5, 0.0001260385076630274,
                       5.355976463100574e-5, 4.1790589865286584e-5, 4.550947218093704e-5,
                       3.8658857501515976e-5, 3.4654137226873145e-5, 3.6817514990980385e-5,
                       3.82970252941279e-5, 4.519865071383538e-5, 0.0001636626329337737,
                       4.1411721285200966e-5, 4.984056030182111e-5, 4.2414672591550025e-5,
                       6.408030019138124e-5, 0.00011170585943749519, 3.451985410748238e-5,
                       2.088365496660003e-5, 5.776499643162971e-5, 4.602652716474653e-5,
                       4.4512661810312244e-5, 4.725260746827623e-5, 4.877907902118133e-5,
                       9.059578468807845e-5, 9.434587115279329e-5, 9.449448796659433e-5,
                       9.788210160647198e-5, 8.816339362649052e-5, 9.964722815366168e-5,
                       0.00016774256148619962, 4.1411721285200966e-5, 0.0002763259815203135,
                       0.0001258645008015576, 4.675000481912711e-5, 0.0001417726825573523,
                       0.0001484721400808648, 9.144995281106056e-5, 0.00013536762326507695,
                       0.00011847558732670345, 0.00010988608761747337, 7.759197063484895e-5,
                       0.0002012627029679272, 7.789500055430903e-5, 7.16761492698751e-5,
                       7.589676853990521e-5, 7.614735284433617e-5, 8.157514541837106e-5,
                       6.596914273008957e-5, 8.682510186523052e-5, 0.00013860200813484136,
                       4.984056030182111e-5, 0.0001258645008015576, 0.0002435032639181437,
                       4.766223033181844e-5, 0.00012821361535144971, 0.00014576858488447918,
                       6.566402477771477e-5, 0.0001040884341423017, 0.0001000898973273539,
                       7.693118937165764e-5, 6.023294227432251e-5, 0.00010819991545083143,
                       6.99205670655645e-5, 4.032122885587511e-5, 4.180160939117253e-5,
                       3.901252996174615e-5, 2.8584673786818277e-5, 3.729904390392456e-5,
                       5.278964088169284e-5, 6.448575831952189e-5, 4.2414672591550025e-5,
                       4.675000481912711e-5, 4.766223033181844e-5, 0.00010544153456416668,
                       4.888979917093638e-5, 5.890309633218628e-5, 4.854687797212978e-5,
                       6.256428871529446e-5, 4.0319712926747976e-5, 4.266179711747866e-5,
                       3.728604207106176e-5, 5.142201848415837e-5, 3.609070272372949e-5,
                       0.00010232427112004749, 9.136264298596868e-5, 0.00013795480216614086,
                       0.00011093805047275677, 0.00011920443213491239,
                       0.00010674626053620905, 0.00010583436864531165, 6.408030019138124e-5,
                       0.0001417726825573523, 0.00012821361535144971, 4.888979917093638e-5,
                       0.0007069290202887314, 0.00023016136774361756, 7.572609978820876e-5,
                       0.0001305570804297047, 0.000137582572844882, 9.304382749222802e-5,
                       6.83166671866209e-5, 0.00012186268035947262, 0.00010813231456878176,
                       3.5842342584471784e-5, 7.145274907967866e-5, 5.835521433661858e-5,
                       0.00010046649151045865, 1.9434887981866837e-5, 0.0001151851632467459,
                       0.00014003499066700457, 0.00011170585943749519,
                       0.0001484721400808648, 0.00014576858488447918, 5.890309633218628e-5,
                       0.00023016136774361756, 0.001944571442370299, 7.833532588935562e-5,
                       0.00022168283252119088, 0.00023389526663147736, 5.963962777663905e-5,
                       5.587193646654157e-5, 0.00010027307926251384, 9.470137480642103e-5,
                       5.3340000288239614e-5, 5.894409490898287e-5, 5.2496942766543964e-5,
                       5.633319789513233e-5, 5.122463295066254e-5, 6.948724266262221e-5,
                       8.969628005119778e-5, 3.451985410748238e-5, 9.144995281106056e-5,
                       6.566402477771477e-5, 4.854687797212978e-5, 7.572609978820876e-5,
                       7.833532588935562e-5, 0.0001437245953721034, 0.00015456149894526363,
                       4.7311050847966925e-5, 6.446480180315105e-5, 5.126749328842405e-5,
                       8.778152919387235e-5, 4.016736337356387e-5, 2.449681502864549e-5,
                       5.4148554331350615e-5, 4.339964646487828e-5, 9.640377176467351e-5,
                       7.752300372527983e-5, 0.00010070782815312086, 0.00024081106289907701,
                       2.088365496660003e-5, 0.00013536762326507695, 0.0001040884341423017,
                       6.256428871529446e-5, 0.0001305570804297047, 0.00022168283252119088,
                       0.00015456149894526363, 0.00099402848851623, 0.00011452369673798565,
                       6.704854732136641e-5, 3.7651302200575364e-5, 0.0001163700590663992,
                       3.5146566548371536e-5, 5.009319527400259e-5, 7.434767187535601e-5,
                       5.64674198400459e-5, 7.791944508596258e-5, 5.711672670998639e-5,
                       4.771810306698167e-5, 0.00012003166381872516, 5.776499643162971e-5,
                       0.00011847558732670345, 0.0001000898973273539, 4.0319712926747976e-5,
                       0.000137582572844882, 0.00023389526663147736, 4.7311050847966925e-5,
                       0.00011452369673798565, 0.0005057529296565075, 7.481453742483862e-5,
                       4.9322000371652104e-5, 9.259400767093014e-5, 7.638902967591361e-5,
                       9.855513889720962e-5, 9.26087447119215e-5, 0.00010169675846289593,
                       0.0001009506423911739, 0.0001045151533625324, 6.472520860458046e-5,
                       0.00013060309394790013, 4.602652716474653e-5, 0.00010988608761747337,
                       7.693118937165764e-5, 4.266179711747866e-5, 9.304382749222802e-5,
                       5.963962777663905e-5, 6.446480180315105e-5, 6.704854732136641e-5,
                       7.481453742483862e-5, 0.00016253747225055678, 6.130280406350881e-5,
                       9.841341349019901e-5, 7.737495932838654e-5, 5.896201914444012e-5,
                       5.098200699940018e-5, 5.4271664241198255e-5, 5.224622997518834e-5,
                       4.647321171914114e-5, 5.61824673338327e-5, 7.416253714990298e-5,
                       4.4512661810312244e-5, 7.759197063484895e-5, 6.023294227432251e-5,
                       3.728604207106176e-5, 6.83166671866209e-5, 5.587193646654157e-5,
                       5.126749328842405e-5, 3.7651302200575364e-5, 4.9322000371652104e-5,
                       6.130280406350881e-5, 0.00012209565787165447, 7.237915002535761e-5,
                       4.4591442469814965e-5, 7.893899674559978e-5, 8.571578189388688e-5,
                       8.136182976094078e-5, 8.448861671887751e-5, 7.525145216929436e-5,
                       9.131329592695117e-5, 0.0001260385076630274, 4.725260746827623e-5,
                       0.0002012627029679272, 0.00010819991545083143, 5.142201848415837e-5,
                       0.00012186268035947262, 0.00010027307926251384, 8.778152919387235e-5,
                       0.0001163700590663992, 9.259400767093014e-5, 9.841341349019901e-5,
                       7.237915002535761e-5, 0.00018499331027535442, 7.09112084692389e-5,
                       8.309615006406581e-5, 7.164341154601614e-5, 8.804054585994111e-5,
                       6.915257063261048e-5, 9.988742986643824e-5, 6.142590082211738e-5,
                       5.355976463100574e-5, 4.877907902118133e-5, 7.789500055430903e-5,
                       6.99205670655645e-5, 3.609070272372949e-5, 0.00010813231456878176,
                       9.470137480642103e-5, 4.016736337356387e-5, 3.5146566548371536e-5,
                       7.638902967591361e-5, 7.737495932838654e-5, 4.4591442469814965e-5,
                       7.09112084692389e-5, 0.0001579623438172991], (20, 20))
    @test isapprox(bl_mut, portfolio.bl_mu)
    @test isapprox(bl_covt, portfolio.bl_cov)
end

@testset "Bayesian Black Litterman" begin
    portfolio = Portfolio(; prices = prices_assets, f_prices = prices_factors)

    asset_sets = DataFrame("Asset" => portfolio.assets,
                           "PDBHT" => [1, 2, 1, 1, 1, 3, 2, 2, 3, 3, 3, 4, 4, 3, 3, 4, 2, 2,
                                       3, 1],
                           "SPDBHT" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 3, 3, 2, 3, 3, 3, 3, 1,
                                        4, 2, 1],
                           "Pward" => [1, 1, 1, 1, 1, 2, 3, 2, 2, 2, 2, 4, 4, 2, 3, 4, 1, 2,
                                       2, 1],
                           "SPward" => [1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 4, 3, 2, 2, 3, 1,
                                        2, 2, 1],
                           "G2DBHT" => [1, 2, 1, 1, 1, 3, 2, 3, 4, 3, 4, 3, 3, 4, 4, 3, 2,
                                        3, 4, 1],
                           "G2ward" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 2, 4, 2, 3, 3, 3, 2, 1,
                                        4, 2, 2])
    views_assets = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           false],
                             "Type" => ["Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Asset"],
                             "Set" => ["", "", "", "", "", "", "", "", "", "", "", "",
                                       "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT",
                                       "Pward", "Pward", "Pward", "Pward", "SPward",
                                       "SPward", ""],
                             "Position" => ["GE", "SBUX", "BABA", "SHLD", "FB", "WMT",
                                            "UAA", "XOM", "UAA", "AMD", "BBY", "FB", 1, 3,
                                            4, 2, 1, 3, 1, 3, 2, 1, 3, 2, "GOOG"],
                             "Sign" => [">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">="],
                             "Return" => [0.3, -0.2, 2.3, -0.7, 0.17, -0.11, 0.13, -0.23,
                                          0.5, -0.37, 0.23, 5.1, 0.27, -0.31, 0.41, -0.19,
                                          0.03, -0.29, 0.71, -0.41, 0.61, -0.019, 1.7, -2.3,
                                          0.69],
                             "Relative_Type" => ["", "", "", "", "Asset", "Asset", "Asset",
                                                 "Asset", "Subset", "Subset", "Subset",
                                                 "Subset", "", "", "", "", "Asset", "Asset",
                                                 "Asset", "Asset", "Subset", "Subset",
                                                 "Subset", "Subset", ""],
                             "Relative_Position" => ["", "", "", "", "GOOG", "AMD", "MA",
                                                     "BAC", 3, 2, 4, 2, "", "", "", "",
                                                     "AAPL", "GE", "PFE", "RRC", 3, 3, 2, 3,
                                                     ""],
                             "Relative_Set" => ["", "", "", "", "", "", "", "", "PDBHT",
                                                "PDBHT", "Pward", "Pward", "", "", "", "",
                                                "", "", "", "", "PDBHT", "Pward", "SPward",
                                                "Pward", ""])

    P, Q = asset_views(views_assets, asset_sets)

    loadings = hcat(DataFrame(:tickers => ["GOOG", "AAPL", "FB", "BABA", "AMZN", "GE",
                                           "AMD", "WMT", "BAC", "GM", "T", "UAA", "SHLD",
                                           "XOM", "RRC", "BBY", "MA", "PFE", "JPM", "SBUX"]),
                    DataFrame(reshape([0.0006662517554895613, 0.0007849399521007353,
                                       0.0009459643095974261, 0.0008592165739551059,
                                       0.0017810088172303237, -0.0005785685052765102,
                                       0.0017612947636060521, 0.0003152090009733905,
                                       0.0008537176877854478, 0.0004723791639856617,
                                       0.00023196965409296734, -0.0005054162297035769,
                                       -0.0014286220563319559, -2.5004548117932975e-5,
                                       -0.0011796361837921718, 0.0011274045369944028,
                                       0.0010443935920757378, 0.00034316200087855785,
                                       0.0008756515571520004, 0.0006211971816987232,
                                       -0.06480893184671563, 0.1265663349283534,
                                       0.06531891020282664, -0.14583770722844627,
                                       0.17384069980818687, -0.10197670562589713,
                                       0.40552722097762517, 0.15455342961953242,
                                       0.13332079577168393, -0.12914789861819334,
                                       0.011581940571448384, 0.13255382044317096,
                                       -0.13950988276499568, 0.05523327575227021,
                                       0.6196572987779644, 0.315267811840457,
                                       0.19010334905522483, 0.21814502022320065,
                                       0.1112154776675108, 0.24492867002761698,
                                       0.03621442191787694, -0.018576988118456626,
                                       -0.033527310265712554, 0.1584057759842692,
                                       -0.017135982753150397, 0.08319092183606666,
                                       0.04095160488367243, -0.02410240121837933,
                                       -0.015985518611239317, 0.042107810262914956,
                                       0.01393611737205343, 0.12788949977560324,
                                       0.3458988137936367, 0.018928053608771953,
                                       -0.12582156590453064, -0.09421231675663434,
                                       -0.036305171782130156, -0.029356961596530413,
                                       -0.017287323397846128, -0.05338133590717126,
                                       -0.11792470271706594, -0.0926516044804406,
                                       -0.19273865391548434, -0.07072481964191567,
                                       -0.02369068378021912, 0.06541829500950368,
                                       0.10382212284974576, -0.03610528820893009,
                                       0.10038297096845941, 0.2944861267239947,
                                       -0.13781284666197124, 0.14227242984111085,
                                       0.6633454725811262, -0.04694291556860392,
                                       -0.22794077702668827, -0.15181516844962,
                                       -0.03792410511305884, -0.12294081844215514,
                                       -0.0018878868853723656, -0.1704758047222016,
                                       0.007948848158307176, -0.08393429696037784,
                                       0.07199537737330614, -0.3003098369766753,
                                       -0.06347006586041148, -0.1424226191965026,
                                       -0.2637077728661142, -0.06769462315395022,
                                       -0.09084369945363698, -0.027867525155884906,
                                       -0.015004515818551027, -0.32886678334558983,
                                       -0.6425048316279028, -0.14876099197615006,
                                       -0.27397526290127255, 0.05766292663184291,
                                       -0.12371744897166051, -0.027224863873640707,
                                       -0.06472451430464957, -0.012397422303371637,
                                       0.24297761348677277, -0.02001368763315179,
                                       0.11071406987599967, 0.45782457720286435,
                                       -0.10902518568940052, 0.1455663926686262,
                                       -0.2576158884320345, -0.10364528131083903,
                                       -0.22512091315073404, -0.16102302797620519,
                                       0.17173019738912326, 0.02121767790834828,
                                       0.041927044324022895, 0.04015829407065362,
                                       -0.395095048650537, -0.19591599492039793,
                                       -0.15760355158485626, -0.04545745159216734,
                                       -0.10326507296810988, -0.06053276587733248], 20, :),
                              [:const, :MTUM, :QUAL, :VLUE, :SIZE, :USMV]))

    views_factors = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                            false],
                              "Factor" => ["MTUM", "USMV", "VLUE", "QUAL", "USMV", "MTUM",
                                           "QUAL", "VLUE", "USMV"],
                              "Sign" => ["<=", "<=", ">=", ">=", "<=", "<=", ">=", ">=",
                                         "<="],
                              "Value" => [0.9, -1.2, 0.3, -0.5, 0.7, -0.13, 0.17, -0.29,
                                          0.72],
                              "Relative_Factor" => ["", "", "", "", "MTUM", "USMV", "VLUE",
                                                    "QUAL", ""])

    f_P, f_Q = factor_views(views_factors, loadings)
    Q ./= 252
    f_Q ./= 252

    asset_statistics!(portfolio)
    bl_type = BBLType(; delta = nothing)
    black_litterman_factor_statistics!(portfolio; P = P, f_P = f_P, Q = Q, f_Q = f_Q,
                                       bl_type = bl_type)

    blfm_mut = [0.0005447777320220783, 0.0009009255450430647, 0.001037774539033381,
                0.0006725768525151147, 0.0017161790383038301, -0.0006266088854884492,
                0.0013270419312161545, 0.00038952161859605566, 0.0009694159381343769,
                0.00030596559886860033, 0.0001956970974261874, -0.0009195568533798216,
                -0.0016658761740125673, 9.56914672815543e-5, -0.0007877714008537025,
                0.0012344034744013054, 0.0011898456888634014, 0.0002548498250201427,
                0.0009840878008532188, 0.0007381984263416494]
    blfm_covt = reshape([0.00020997610750394225, -3.4320347494989007e-7,
                         -2.1237293704412552e-7, 5.309217732352118e-7, 1.346522610757405e-7,
                         3.823054662425881e-7, 8.78657187340055e-7, -2.145289681238519e-7,
                         -3.325332595036254e-7, 4.6531352370236845e-7,
                         1.5921491525335348e-7, 8.204729300584097e-7, 2.206024643767527e-6,
                         -3.7898577138420996e-7, -1.2176610369469844e-6,
                         -2.7184755606463985e-7, -4.944550839790097e-7,
                         2.1961374071006548e-7, -2.877514897406676e-7,
                         -3.0452514040879953e-7, -3.432034749498901e-7,
                         0.0002116779616188623, 2.448859059191326e-7,
                         -4.6725581178067285e-7, -1.267852837400123e-7,
                         -3.734876904022239e-7, -8.273221698404914e-7,
                         4.1456031727139233e-7, 2.926572349192451e-7, -5.365501149734662e-7,
                         -1.4012251564099674e-7, -7.725372927822014e-7,
                         -2.155143260882148e-6, 7.323601236718635e-7, 2.3530339525724398e-6,
                         3.1346571726773117e-7, 9.554954665723809e-7,
                         -2.0678294004635602e-7, 2.5324551131246817e-7,
                         3.511460354699781e-7, -2.123729370441254e-7, 2.448859059191325e-7,
                         0.00025724153915178286, -2.891360267062773e-7,
                         -8.166712282142896e-8, -2.4984441106822753e-7,
                         -5.329090195972927e-7, 1.5307281114381678e-7,
                         1.8109512596306704e-7, -3.942942957988162e-7,
                         -8.670725200854907e-8, -4.976200400604327e-7,
                         -1.4416820490198251e-6, 2.7041764064141286e-7,
                         8.688374328923385e-7, 2.303563838640928e-7, 3.528084358533952e-7,
                         -1.3319659241187176e-7, 1.5670730909272627e-7,
                         2.5804649913275687e-7, 5.30921773235212e-7, -4.6725581178067254e-7,
                         -2.891360267062772e-7, 0.0004006282718896373,
                         1.8332288612822034e-7, 5.204913819810561e-7, 1.1962515164144075e-6,
                         -2.920713642710529e-7, -4.5272880216648676e-7,
                         6.335030502876474e-7, 2.1676381477535652e-7, 1.117036315073686e-6,
                         3.0034015124184435e-6, -5.159717694796325e-7,
                         -1.6577897306413656e-6, -3.701079964534781e-7,
                         -6.731779498661133e-7, 2.989940492550503e-7,
                         -3.9176047372336384e-7, -4.145970308433282e-7,
                         1.3465226107574055e-7, -1.267852837400123e-7,
                         -8.166712282142897e-8, 1.8332288612822034e-7,
                         0.0003311044888329338, 1.4459837457741155e-7, 3.750632964973125e-7,
                         -7.925070134562555e-8, -1.1482097728702829e-7,
                         1.7893436527073905e-7, 5.497559009691217e-8, 3.5022678499461204e-7,
                         8.343788042101578e-7, -1.400038812701127e-7, -4.498249911106573e-7,
                         -1.045378382897415e-7, -1.826602371322828e-7, 9.374424375469769e-8,
                         -9.935820349862338e-8, -1.1710386638769833e-7,
                         3.823054662425884e-7, -3.734876904022238e-7, -2.498444110682276e-7,
                         5.204913819810563e-7, 1.4459837457741147e-7,
                         0.00017908800314179226, 9.435593586405981e-7,
                         -2.3345896728070228e-7, -3.2600037240708145e-7,
                         5.474143029219635e-7, 1.5608700838777088e-7, 8.81077310721719e-7,
                         2.5267583323208384e-6, -4.124274105041053e-7,
                         -1.3251072368906134e-6, -3.198128419309614e-7,
                         -5.380857153323443e-7, 2.3583554919793183e-7,
                         -2.8209837703505695e-7, -3.5825611972912346e-7,
                         8.786571873400545e-7, -8.273221698404917e-7, -5.329090195972925e-7,
                         1.196251516414407e-6, 3.750632964973124e-7, 9.435593586405978e-7,
                         0.001648186722803095, -5.17140950941073e-7, -7.492505223800731e-7,
                         1.1676147496612023e-6, 3.5873662262337884e-7,
                         2.2853628997839213e-6, 5.444638860323894e-6, -9.135785433583863e-7,
                         -2.9352790538157827e-6, -6.821491316109977e-7,
                         -1.1919274798307458e-6, 6.117168244244439e-7,
                         -6.483500457237391e-7, -7.641472415304162e-7,
                         -2.1452896812385196e-7, 4.1456031727139223e-7,
                         1.530728111438168e-7, -2.9207136427105284e-7,
                         -7.925070134562555e-8, -2.334589672807023e-7,
                         -5.171409509410725e-7, 0.00016359578668841235,
                         1.829336216084996e-7, -3.353857140543171e-7, -8.758751261411418e-8,
                         -4.828961253435957e-7, -1.3471328050615616e-6,
                         4.5778225773885556e-7, 1.4708299380694139e-6,
                         1.9594054773911615e-7, 5.972592687784409e-7,
                         -1.2925548251001268e-7, 1.5829821720713457e-7,
                         2.1949368857979863e-7, -3.3253325950362535e-7,
                         2.926572349192451e-7, 1.8109512596306698e-7,
                         -4.5272880216648676e-7, -1.1482097728702829e-7,
                         -3.2600037240708145e-7, -7.492505223800732e-7,
                         1.829336216084996e-7, 0.00027620000630927357,
                         -3.9678318885654794e-7, -1.357660987050075e-7,
                         -6.996355123503453e-7, -1.8811262691992846e-6,
                         3.2316959478115434e-7, 1.0383266433821383e-6, 2.318104561413545e-7,
                         4.216328453264879e-7, -1.8726952026305631e-7,
                         2.4537209404331605e-7, 2.5967535896437655e-7, 4.653135237023685e-7,
                         -5.365501149734662e-7, -3.942942957988161e-7, 6.335030502876472e-7,
                         1.789343652707391e-7, 5.474143029219633e-7, 1.1676147496612018e-6,
                         -3.3538571405431705e-7, -3.967831888565479e-7,
                         0.00024332257576382578, 1.8997739318482183e-7, 1.09029586127221e-6,
                         3.15875536508912e-6, -5.924906769641401e-7, -1.9036408925288588e-6,
                         -5.047156298491346e-7, -7.730106234993344e-7,
                         2.9183650526732976e-7, -3.433489746798682e-7,
                         -5.653852485242758e-7, 1.5921491525335343e-7,
                         -1.4012251564099666e-7, -8.670725200854909e-8,
                         2.1676381477535658e-7, 5.497559009691216e-8, 1.5608700838777085e-7,
                         3.5873662262337895e-7, -8.75875126141142e-8,
                         -1.3576609870500753e-7, 1.8997739318482183e-7,
                         0.00010534983603159521, 3.34981255629506e-7, 9.00671890620781e-7,
                         -1.5473164916600203e-7, -4.971445225604082e-7,
                         -1.1098944564065356e-7, -2.018752585437403e-7,
                         8.966351468940391e-8, -1.1748267591927453e-7,
                         -1.243309927332144e-7, 8.204729300584095e-7, -7.725372927822012e-7,
                         -4.976200400604328e-7, 1.1170363150736861e-6,
                         3.5022678499461204e-7, 8.810773107217189e-7, 2.2853628997839217e-6,
                         -4.828961253435956e-7, -6.996355123503454e-7,
                         1.0902958612722102e-6, 3.349812556295061e-7, 0.0007066892152862239,
                         5.0840974878533095e-6, -8.530818106398244e-7,
                         -2.7409062835005896e-6, -6.369775434763136e-7,
                         -1.1129986141175074e-6, 5.712092298714753e-7, -6.05416616836465e-7,
                         -7.135457779074278e-7, 2.2060246437675256e-6,
                         -2.155143260882149e-6, -1.4416820490198245e-6,
                         3.0034015124184418e-6, 8.343788042101578e-7, 2.5267583323208376e-6,
                         5.444638860323894e-6, -1.3471328050615607e-6,
                         -1.881126269199284e-6, 3.1587553650891196e-6, 9.006718906207808e-7,
                         5.084097487853307e-6, 0.0019439770135162018,
                         -2.3798378827258556e-6, -7.646291979410223e-6,
                         -1.845422242132817e-6, -3.104926435263709e-6,
                         1.3608464417742878e-6, -1.6277977341586687e-6,
                         -2.067252233326647e-6, -3.789857713842098e-7, 7.323601236718637e-7,
                         2.7041764064141286e-7, -5.159717694796325e-7,
                         -1.4000388127011265e-7, -4.124274105041055e-7,
                         -9.135785433583867e-7, 4.5778225773885545e-7, 3.231695947811542e-7,
                         -5.924906769641402e-7, -1.5473164916600206e-7,
                         -8.530818106398242e-7, -2.3798378827258556e-6,
                         0.00014382363098558324, 2.5983606015035425e-6,
                         3.4614756356578615e-7, 1.0551151514591193e-6,
                         -2.2834207041174423e-7, 2.796488161093287e-7, 3.877564209993132e-7,
                         -1.2176610369469849e-6, 2.3530339525724406e-6,
                         8.688374328923385e-7, -1.6577897306413664e-6,
                         -4.498249911106574e-7, -1.3251072368906137e-6,
                         -2.9352790538157827e-6, 1.4708299380694132e-6,
                         1.0383266433821381e-6, -1.903640892528859e-6, -4.97144522560408e-7,
                         -2.740906283500589e-6, -7.646291979410221e-6, 2.598360601503544e-6,
                         0.0009956472119869901, 1.112153629537946e-6, 3.390028614350544e-6,
                         -7.336508735424522e-7, 8.98496706514795e-7, 1.2458406656069696e-6,
                         -2.7184755606464e-7, 3.1346571726773117e-7, 2.303563838640928e-7,
                         -3.70107996453478e-7, -1.0453783828974152e-7,
                         -3.198128419309614e-7, -6.821491316109979e-7,
                         1.9594054773911618e-7, 2.3181045614135457e-7,
                         -5.047156298491346e-7, -1.1098944564065358e-7,
                         -6.369775434763137e-7, -1.8454222421328168e-6,
                         3.4614756356578615e-7, 1.1121536295379457e-6,
                         0.0005054587171260083, 4.5161173726107197e-7,
                         -1.7049803344661568e-7, 2.0059287961663645e-7,
                         3.3031190845988535e-7, -4.944550839790098e-7, 9.554954665723809e-7,
                         3.5280843585339515e-7, -6.731779498661132e-7,
                         -1.8266023713228273e-7, -5.380857153323443e-7,
                         -1.1919274798307456e-6, 5.972592687784409e-7,
                         4.2163284532648784e-7, -7.730106234993347e-7,
                         -2.0187525854374032e-7, -1.1129986141175072e-6,
                         -3.1049264352637097e-6, 1.0551151514591195e-6,
                         3.3900286143505454e-6, 4.51611737261072e-7, 0.00016275944316891032,
                         -2.9791328890529443e-7, 3.648521641035147e-7, 5.05897973447253e-7,
                         2.1961374071006548e-7, -2.0678294004635613e-7,
                         -1.331965924118718e-7, 2.989940492550501e-7, 9.374424375469769e-8,
                         2.3583554919793177e-7, 6.11716824424444e-7, -1.2925548251001273e-7,
                         -1.8726952026305631e-7, 2.9183650526732987e-7, 8.96635146894039e-8,
                         5.712092298714754e-7, 1.3608464417742885e-6, -2.283420704117442e-7,
                         -7.336508735424523e-7, -1.7049803344661576e-7,
                         -2.979132889052944e-7, 0.00012202568631634672,
                         -1.620502067045931e-7, -1.9099284292410228e-7,
                         -2.877514897406675e-7, 2.532455113124681e-7, 1.5670730909272635e-7,
                         -3.917604737233638e-7, -9.935820349862337e-8,
                         -2.8209837703505685e-7, -6.483500457237388e-7,
                         1.5829821720713455e-7, 2.4537209404331605e-7,
                         -3.433489746798683e-7, -1.1748267591927457e-7,
                         -6.05416616836465e-7, -1.6277977341586695e-6, 2.796488161093288e-7,
                         8.984967065147947e-7, 2.0059287961663645e-7, 3.648521641035147e-7,
                         -1.620502067045931e-7, 0.0001849013008788083,
                         2.2470525655833638e-7, -3.045251404087997e-7,
                         3.5114603546997806e-7, 2.580464991327568e-7, -4.145970308433281e-7,
                         -1.1710386638769829e-7, -3.5825611972912335e-7,
                         -7.641472415304166e-7, 2.194936885797986e-7, 2.5967535896437655e-7,
                         -5.653852485242757e-7, -1.2433099273321446e-7,
                         -7.135457779074277e-7, -2.0672522333266476e-6,
                         3.877564209993132e-7, 1.2458406656069699e-6, 3.3031190845988535e-7,
                         5.058979734472527e-7, -1.909928429241023e-7, 2.2470525655833638e-7,
                         0.00015789205484314828], (20, 20))
    @test isapprox(blfm_mut, portfolio.blfm_mu)
    @test isapprox(blfm_covt, portfolio.blfm_cov)
end

@testset "Augmented Black Litterman" begin
    portfolio = Portfolio(; prices = prices_assets, f_prices = prices_factors)

    asset_sets = DataFrame("Asset" => portfolio.assets,
                           "PDBHT" => [1, 2, 1, 1, 1, 3, 2, 2, 3, 3, 3, 4, 4, 3, 3, 4, 2, 2,
                                       3, 1],
                           "SPDBHT" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 3, 3, 2, 3, 3, 3, 3, 1,
                                        4, 2, 1],
                           "Pward" => [1, 1, 1, 1, 1, 2, 3, 2, 2, 2, 2, 4, 4, 2, 3, 4, 1, 2,
                                       2, 1],
                           "SPward" => [1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 4, 3, 2, 2, 3, 1,
                                        2, 2, 1],
                           "G2DBHT" => [1, 2, 1, 1, 1, 3, 2, 3, 4, 3, 4, 3, 3, 4, 4, 3, 2,
                                        3, 4, 1],
                           "G2ward" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 2, 4, 2, 3, 3, 3, 2, 1,
                                        4, 2, 2])
    views_assets = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           false],
                             "Type" => ["Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Asset"],
                             "Set" => ["", "", "", "", "", "", "", "", "", "", "", "",
                                       "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT",
                                       "Pward", "Pward", "Pward", "Pward", "SPward",
                                       "SPward", ""],
                             "Position" => ["GE", "SBUX", "BABA", "SHLD", "FB", "WMT",
                                            "UAA", "XOM", "UAA", "AMD", "BBY", "FB", 1, 3,
                                            4, 2, 1, 3, 1, 3, 2, 1, 3, 2, "GOOG"],
                             "Sign" => [">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">="],
                             "Return" => [0.3, -0.2, 2.3, -0.7, 0.17, -0.11, 0.13, -0.23,
                                          0.5, -0.37, 0.23, 5.1, 0.27, -0.31, 0.41, -0.19,
                                          0.03, -0.29, 0.71, -0.41, 0.61, -0.019, 1.7, -2.3,
                                          0.69],
                             "Relative_Type" => ["", "", "", "", "Asset", "Asset", "Asset",
                                                 "Asset", "Subset", "Subset", "Subset",
                                                 "Subset", "", "", "", "", "Asset", "Asset",
                                                 "Asset", "Asset", "Subset", "Subset",
                                                 "Subset", "Subset", ""],
                             "Relative_Position" => ["", "", "", "", "GOOG", "AMD", "MA",
                                                     "BAC", 3, 2, 4, 2, "", "", "", "",
                                                     "AAPL", "GE", "PFE", "RRC", 3, 3, 2, 3,
                                                     ""],
                             "Relative_Set" => ["", "", "", "", "", "", "", "", "PDBHT",
                                                "PDBHT", "Pward", "Pward", "", "", "", "",
                                                "", "", "", "", "PDBHT", "Pward", "SPward",
                                                "Pward", ""])

    P, Q = asset_views(views_assets, asset_sets)

    loadings = hcat(DataFrame(:tickers => ["GOOG", "AAPL", "FB", "BABA", "AMZN", "GE",
                                           "AMD", "WMT", "BAC", "GM", "T", "UAA", "SHLD",
                                           "XOM", "RRC", "BBY", "MA", "PFE", "JPM", "SBUX"]),
                    DataFrame(reshape([0.0006662517554895613, 0.0007849399521007353,
                                       0.0009459643095974261, 0.0008592165739551059,
                                       0.0017810088172303237, -0.0005785685052765102,
                                       0.0017612947636060521, 0.0003152090009733905,
                                       0.0008537176877854478, 0.0004723791639856617,
                                       0.00023196965409296734, -0.0005054162297035769,
                                       -0.0014286220563319559, -2.5004548117932975e-5,
                                       -0.0011796361837921718, 0.0011274045369944028,
                                       0.0010443935920757378, 0.00034316200087855785,
                                       0.0008756515571520004, 0.0006211971816987232,
                                       -0.06480893184671563, 0.1265663349283534,
                                       0.06531891020282664, -0.14583770722844627,
                                       0.17384069980818687, -0.10197670562589713,
                                       0.40552722097762517, 0.15455342961953242,
                                       0.13332079577168393, -0.12914789861819334,
                                       0.011581940571448384, 0.13255382044317096,
                                       -0.13950988276499568, 0.05523327575227021,
                                       0.6196572987779644, 0.315267811840457,
                                       0.19010334905522483, 0.21814502022320065,
                                       0.1112154776675108, 0.24492867002761698,
                                       0.03621442191787694, -0.018576988118456626,
                                       -0.033527310265712554, 0.1584057759842692,
                                       -0.017135982753150397, 0.08319092183606666,
                                       0.04095160488367243, -0.02410240121837933,
                                       -0.015985518611239317, 0.042107810262914956,
                                       0.01393611737205343, 0.12788949977560324,
                                       0.3458988137936367, 0.018928053608771953,
                                       -0.12582156590453064, -0.09421231675663434,
                                       -0.036305171782130156, -0.029356961596530413,
                                       -0.017287323397846128, -0.05338133590717126,
                                       -0.11792470271706594, -0.0926516044804406,
                                       -0.19273865391548434, -0.07072481964191567,
                                       -0.02369068378021912, 0.06541829500950368,
                                       0.10382212284974576, -0.03610528820893009,
                                       0.10038297096845941, 0.2944861267239947,
                                       -0.13781284666197124, 0.14227242984111085,
                                       0.6633454725811262, -0.04694291556860392,
                                       -0.22794077702668827, -0.15181516844962,
                                       -0.03792410511305884, -0.12294081844215514,
                                       -0.0018878868853723656, -0.1704758047222016,
                                       0.007948848158307176, -0.08393429696037784,
                                       0.07199537737330614, -0.3003098369766753,
                                       -0.06347006586041148, -0.1424226191965026,
                                       -0.2637077728661142, -0.06769462315395022,
                                       -0.09084369945363698, -0.027867525155884906,
                                       -0.015004515818551027, -0.32886678334558983,
                                       -0.6425048316279028, -0.14876099197615006,
                                       -0.27397526290127255, 0.05766292663184291,
                                       -0.12371744897166051, -0.027224863873640707,
                                       -0.06472451430464957, -0.012397422303371637,
                                       0.24297761348677277, -0.02001368763315179,
                                       0.11071406987599967, 0.45782457720286435,
                                       -0.10902518568940052, 0.1455663926686262,
                                       -0.2576158884320345, -0.10364528131083903,
                                       -0.22512091315073404, -0.16102302797620519,
                                       0.17173019738912326, 0.02121767790834828,
                                       0.041927044324022895, 0.04015829407065362,
                                       -0.395095048650537, -0.19591599492039793,
                                       -0.15760355158485626, -0.04545745159216734,
                                       -0.10326507296810988, -0.06053276587733248], 20, :),
                              [:const, :MTUM, :QUAL, :VLUE, :SIZE, :USMV]))

    views_factors = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                            false],
                              "Factor" => ["MTUM", "USMV", "VLUE", "QUAL", "USMV", "MTUM",
                                           "QUAL", "VLUE", "USMV"],
                              "Sign" => ["<=", "<=", ">=", ">=", "<=", "<=", ">=", ">=",
                                         "<="],
                              "Value" => [0.9, -1.2, 0.3, -0.5, 0.7, -0.13, 0.17, -0.29,
                                          0.72],
                              "Relative_Factor" => ["", "", "", "", "MTUM", "USMV", "VLUE",
                                                    "QUAL", ""])

    f_P, f_Q = factor_views(views_factors, loadings)
    Q ./= 252
    f_Q ./= 252

    asset_statistics!(portfolio)
    bl_type = ABLType(; delta = nothing)

    @test_throws AssertionError PortfolioOptimiser.black_litterman(bl_type,
                                                                   portfolio.returns;
                                                                   w = fill(inv(20), 20))

    black_litterman_factor_statistics!(portfolio; P = P, Q = Q, bl_type = bl_type)

    blfm_mut = [0.0033999924007108817, 0.0020577491946595027, 0.0069096286018665515,
                0.004207555076029281, 0.0026142257950789397, -0.0007527699772210183,
                0.001828674419126373, 0.0004401118768130399, -0.002241992416954619,
                -0.0020089886562241616, -0.001181063489372343, 0.0008625885754303794,
                0.0017775370644092128, -0.0020581128744383828, -0.0018858560161551811,
                0.0016242331286812465, 0.0006392444728674756, -0.0003173620766621279,
                -0.002141811461344292, 7.770832892548571e-5]
    blfm_covt = reshape([0.00021008255252989567, 9.80719618642883e-5,
                         0.00014082908567946293, 0.0001182374909141455,
                         0.00015844390570223703, 6.20415912590239e-5, 8.225897171845311e-5,
                         4.1790589865286584e-5, 9.059578468807845e-5, 7.16761492698751e-5,
                         4.032122885587511e-5, 0.00010232427112004749,
                         3.5842342584471784e-5, 5.3340000288239614e-5, 2.449681502864549e-5,
                         5.009319527400259e-5, 9.855513889720962e-5, 5.896201914444012e-5,
                         7.893899674559978e-5, 8.309615006406581e-5, 9.80719618642883e-5,
                         0.00021162581037800714, 0.00010918355839011303,
                         9.46211724151634e-5, 0.00010731797543543672, 5.819629526680374e-5,
                         0.00013025274055683783, 4.550947218093704e-5, 9.434587115279329e-5,
                         7.589676853990521e-5, 4.180160939117253e-5, 9.136264298596868e-5,
                         7.145274907967866e-5, 5.894409490898287e-5, 5.4148554331350615e-5,
                         7.434767187535601e-5, 9.26087447119215e-5, 5.098200699940018e-5,
                         8.571578189388688e-5, 7.164341154601614e-5, 0.00014082908567946293,
                         0.00010918355839011303, 0.0002573380149266721,
                         0.00011934634285606628, 0.0001533770061180058,
                         6.706671382419828e-5, 0.0001170975334376465, 3.8658857501515976e-5,
                         9.449448796659433e-5, 7.614735284433617e-5, 3.901252996174615e-5,
                         0.00013795480216614086, 5.835521433661858e-5,
                         5.2496942766543964e-5, 4.339964646487828e-5, 5.64674198400459e-5,
                         0.00010169675846289593, 5.4271664241198255e-5,
                         8.136182976094078e-5, 8.804054585994111e-5, 0.0001182374909141455,
                         9.46211724151634e-5, 0.00011934634285606628, 0.0004008077171526529,
                         0.00013259900955581738, 6.51219379664725e-5,
                         0.00020069084205797497, 3.4654137226873145e-5,
                         9.788210160647198e-5, 8.157514541837106e-5, 2.8584673786818277e-5,
                         0.00011093805047275677, 0.00010046649151045865,
                         5.633319789513233e-5, 9.640377176467351e-5, 7.791944508596258e-5,
                         0.0001009506423911739, 5.224622997518834e-5, 8.448861671887751e-5,
                         6.915257063261048e-5, 0.00015844390570223703,
                         0.00010731797543543672, 0.0001533770061180058,
                         0.00013259900955581738, 0.0003313175449413421,
                         5.1652696406059975e-5, 0.00012078522849302118,
                         3.6817514990980385e-5, 8.816339362649052e-5, 6.596914273008957e-5,
                         3.729904390392456e-5, 0.00011920443213491239,
                         1.9434887981866837e-5, 5.122463295066254e-5, 7.752300372527983e-5,
                         5.711672670998639e-5, 0.0001045151533625324, 4.647321171914114e-5,
                         7.525145216929436e-5, 9.988742986643824e-5, 6.20415912590239e-5,
                         5.819629526680374e-5, 6.706671382419828e-5, 6.51219379664725e-5,
                         5.1652696406059975e-5, 0.0001791519215285957, 9.457602525288688e-5,
                         3.82970252941279e-5, 9.964722815366168e-5, 8.682510186523052e-5,
                         5.278964088169284e-5, 0.00010674626053620905,
                         0.0001151851632467459, 6.948724266262221e-5,
                         0.00010070782815312086, 4.771810306698167e-5, 6.472520860458046e-5,
                         5.61824673338327e-5, 9.131329592695117e-5, 6.142590082211738e-5,
                         8.225897171845311e-5, 0.00013025274055683783,
                         0.0001170975334376465, 0.00020069084205797497,
                         0.00012078522849302118, 9.457602525288688e-5,
                         0.0016485277656449599, 4.519865071383538e-5,
                         0.00016774256148619962, 0.00013860200813484136,
                         6.448575831952189e-5, 0.00010583436864531165,
                         0.00014003499066700457, 8.969628005119778e-5,
                         0.00024081106289907701, 0.00012003166381872516,
                         0.00013060309394790013, 7.416253714990298e-5,
                         0.0001260385076630274, 5.355976463100574e-5, 4.1790589865286584e-5,
                         4.550947218093704e-5, 3.8658857501515976e-5, 3.4654137226873145e-5,
                         3.6817514990980385e-5, 3.82970252941279e-5, 4.519865071383538e-5,
                         0.0001636626329337737, 4.1411721285200966e-5, 4.984056030182111e-5,
                         4.2414672591550025e-5, 6.408030019138124e-5,
                         0.00011170585943749519, 3.451985410748238e-5, 2.088365496660003e-5,
                         5.776499643162971e-5, 4.602652716474653e-5, 4.4512661810312244e-5,
                         4.725260746827623e-5, 4.877907902118133e-5, 9.059578468807845e-5,
                         9.434587115279329e-5, 9.449448796659433e-5, 9.788210160647198e-5,
                         8.816339362649052e-5, 9.964722815366168e-5, 0.00016774256148619962,
                         4.1411721285200966e-5, 0.0002763259815203135,
                         0.0001258645008015576, 4.675000481912711e-5, 0.0001417726825573523,
                         0.0001484721400808648, 9.144995281106056e-5,
                         0.00013536762326507695, 0.00011847558732670345,
                         0.00010988608761747337, 7.759197063484895e-5,
                         0.0002012627029679272, 7.789500055430903e-5, 7.16761492698751e-5,
                         7.589676853990521e-5, 7.614735284433617e-5, 8.157514541837106e-5,
                         6.596914273008957e-5, 8.682510186523052e-5, 0.00013860200813484136,
                         4.984056030182111e-5, 0.0001258645008015576, 0.0002435032639181437,
                         4.766223033181844e-5, 0.00012821361535144971,
                         0.00014576858488447918, 6.566402477771477e-5,
                         0.0001040884341423017, 0.0001000898973273539, 7.693118937165764e-5,
                         6.023294227432251e-5, 0.00010819991545083143, 6.99205670655645e-5,
                         4.032122885587511e-5, 4.180160939117253e-5, 3.901252996174615e-5,
                         2.8584673786818277e-5, 3.729904390392456e-5, 5.278964088169284e-5,
                         6.448575831952189e-5, 4.2414672591550025e-5, 4.675000481912711e-5,
                         4.766223033181844e-5, 0.00010544153456416668, 4.888979917093638e-5,
                         5.890309633218628e-5, 4.854687797212978e-5, 6.256428871529446e-5,
                         4.0319712926747976e-5, 4.266179711747866e-5, 3.728604207106176e-5,
                         5.142201848415837e-5, 3.609070272372949e-5, 0.00010232427112004749,
                         9.136264298596868e-5, 0.00013795480216614086,
                         0.00011093805047275677, 0.00011920443213491239,
                         0.00010674626053620905, 0.00010583436864531165,
                         6.408030019138124e-5, 0.0001417726825573523,
                         0.00012821361535144971, 4.888979917093638e-5,
                         0.0007069290202887314, 0.00023016136774361756,
                         7.572609978820876e-5, 0.0001305570804297047, 0.000137582572844882,
                         9.304382749222802e-5, 6.83166671866209e-5, 0.00012186268035947262,
                         0.00010813231456878176, 3.5842342584471784e-5,
                         7.145274907967866e-5, 5.835521433661858e-5, 0.00010046649151045865,
                         1.9434887981866837e-5, 0.0001151851632467459,
                         0.00014003499066700457, 0.00011170585943749519,
                         0.0001484721400808648, 0.00014576858488447918,
                         5.890309633218628e-5, 0.00023016136774361756, 0.001944571442370299,
                         7.833532588935562e-5, 0.00022168283252119088,
                         0.00023389526663147736, 5.963962777663905e-5, 5.587193646654157e-5,
                         0.00010027307926251384, 9.470137480642103e-5,
                         5.3340000288239614e-5, 5.894409490898287e-5, 5.2496942766543964e-5,
                         5.633319789513233e-5, 5.122463295066254e-5, 6.948724266262221e-5,
                         8.969628005119778e-5, 3.451985410748238e-5, 9.144995281106056e-5,
                         6.566402477771477e-5, 4.854687797212978e-5, 7.572609978820876e-5,
                         7.833532588935562e-5, 0.0001437245953721034,
                         0.00015456149894526363, 4.7311050847966925e-5,
                         6.446480180315105e-5, 5.126749328842405e-5, 8.778152919387235e-5,
                         4.016736337356387e-5, 2.449681502864549e-5, 5.4148554331350615e-5,
                         4.339964646487828e-5, 9.640377176467351e-5, 7.752300372527983e-5,
                         0.00010070782815312086, 0.00024081106289907701,
                         2.088365496660003e-5, 0.00013536762326507695,
                         0.0001040884341423017, 6.256428871529446e-5, 0.0001305570804297047,
                         0.00022168283252119088, 0.00015456149894526363,
                         0.00099402848851623, 0.00011452369673798565, 6.704854732136641e-5,
                         3.7651302200575364e-5, 0.0001163700590663992,
                         3.5146566548371536e-5, 5.009319527400259e-5, 7.434767187535601e-5,
                         5.64674198400459e-5, 7.791944508596258e-5, 5.711672670998639e-5,
                         4.771810306698167e-5, 0.00012003166381872516, 5.776499643162971e-5,
                         0.00011847558732670345, 0.0001000898973273539,
                         4.0319712926747976e-5, 0.000137582572844882,
                         0.00023389526663147736, 4.7311050847966925e-5,
                         0.00011452369673798565, 0.0005057529296565075,
                         7.481453742483862e-5, 4.9322000371652104e-5, 9.259400767093014e-5,
                         7.638902967591361e-5, 9.855513889720962e-5, 9.26087447119215e-5,
                         0.00010169675846289593, 0.0001009506423911739,
                         0.0001045151533625324, 6.472520860458046e-5,
                         0.00013060309394790013, 4.602652716474653e-5,
                         0.00010988608761747337, 7.693118937165764e-5, 4.266179711747866e-5,
                         9.304382749222802e-5, 5.963962777663905e-5, 6.446480180315105e-5,
                         6.704854732136641e-5, 7.481453742483862e-5, 0.00016253747225055678,
                         6.130280406350881e-5, 9.841341349019901e-5, 7.737495932838654e-5,
                         5.896201914444012e-5, 5.098200699940018e-5, 5.4271664241198255e-5,
                         5.224622997518834e-5, 4.647321171914114e-5, 5.61824673338327e-5,
                         7.416253714990298e-5, 4.4512661810312244e-5, 7.759197063484895e-5,
                         6.023294227432251e-5, 3.728604207106176e-5, 6.83166671866209e-5,
                         5.587193646654157e-5, 5.126749328842405e-5, 3.7651302200575364e-5,
                         4.9322000371652104e-5, 6.130280406350881e-5,
                         0.00012209565787165447, 7.237915002535761e-5,
                         4.4591442469814965e-5, 7.893899674559978e-5, 8.571578189388688e-5,
                         8.136182976094078e-5, 8.448861671887751e-5, 7.525145216929436e-5,
                         9.131329592695117e-5, 0.0001260385076630274, 4.725260746827623e-5,
                         0.0002012627029679272, 0.00010819991545083143,
                         5.142201848415837e-5, 0.00012186268035947262,
                         0.00010027307926251384, 8.778152919387235e-5,
                         0.0001163700590663992, 9.259400767093014e-5, 9.841341349019901e-5,
                         7.237915002535761e-5, 0.00018499331027535442, 7.09112084692389e-5,
                         8.309615006406581e-5, 7.164341154601614e-5, 8.804054585994111e-5,
                         6.915257063261048e-5, 9.988742986643824e-5, 6.142590082211738e-5,
                         5.355976463100574e-5, 4.877907902118133e-5, 7.789500055430903e-5,
                         6.99205670655645e-5, 3.609070272372949e-5, 0.00010813231456878176,
                         9.470137480642103e-5, 4.016736337356387e-5, 3.5146566548371536e-5,
                         7.638902967591361e-5, 7.737495932838654e-5, 4.4591442469814965e-5,
                         7.09112084692389e-5, 0.0001579623438172991], (20, 20))
    @test isapprox(blfm_mut, portfolio.blfm_mu)
    @test isapprox(blfm_covt, portfolio.blfm_cov)

    asset_sets = DataFrame("Asset" => portfolio.assets,
                           "PDBHT" => [1, 2, 1, 1, 1, 3, 2, 2, 3, 3, 3, 4, 4, 3, 3, 4, 2, 2,
                                       3, 1],
                           "SPDBHT" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 3, 3, 2, 3, 3, 3, 3, 1,
                                        4, 2, 1],
                           "Pward" => [1, 1, 1, 1, 1, 2, 3, 2, 2, 2, 2, 4, 4, 2, 3, 4, 1, 2,
                                       2, 1],
                           "SPward" => [1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 4, 3, 2, 2, 3, 1,
                                        2, 2, 1],
                           "G2DBHT" => [1, 2, 1, 1, 1, 3, 2, 3, 4, 3, 4, 3, 3, 4, 4, 3, 2,
                                        3, 4, 1],
                           "G2ward" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 2, 4, 2, 3, 3, 3, 2, 1,
                                        4, 2, 2])
    views_assets = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           false],
                             "Type" => ["Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Asset"],
                             "Set" => ["", "", "", "", "", "", "", "", "", "", "", "",
                                       "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT",
                                       "Pward", "Pward", "Pward", "Pward", "SPward",
                                       "SPward", ""],
                             "Position" => ["GE", "SBUX", "BABA", "SHLD", "FB", "WMT",
                                            "UAA", "XOM", "UAA", "AMD", "BBY", "FB", 1, 3,
                                            4, 2, 1, 3, 1, 3, 2, 1, 3, 2, "GOOG"],
                             "Sign" => [">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">="],
                             "Return" => [0.3, -0.2, 2.3, -0.7, 0.17, -0.11, 0.13, -0.23,
                                          0.5, -0.37, 0.23, 5.1, 0.27, -0.31, 0.41, -0.19,
                                          0.03, -0.29, 0.71, -0.41, 0.61, -0.019, 1.7, -2.3,
                                          0.69],
                             "Relative_Type" => ["", "", "", "", "Asset", "Asset", "Asset",
                                                 "Asset", "Subset", "Subset", "Subset",
                                                 "Subset", "", "", "", "", "Asset", "Asset",
                                                 "Asset", "Asset", "Subset", "Subset",
                                                 "Subset", "Subset", ""],
                             "Relative_Position" => ["", "", "", "", "GOOG", "AMD", "MA",
                                                     "BAC", 3, 2, 4, 2, "", "", "", "",
                                                     "AAPL", "GE", "PFE", "RRC", 3, 3, 2, 3,
                                                     ""],
                             "Relative_Set" => ["", "", "", "", "", "", "", "", "PDBHT",
                                                "PDBHT", "Pward", "Pward", "", "", "", "",
                                                "", "", "", "", "PDBHT", "Pward", "SPward",
                                                "Pward", ""])

    P, Q = asset_views(views_assets, asset_sets)

    loadings = hcat(DataFrame(:tickers => ["GOOG", "AAPL", "FB", "BABA", "AMZN", "GE",
                                           "AMD", "WMT", "BAC", "GM", "T", "UAA", "SHLD",
                                           "XOM", "RRC", "BBY", "MA", "PFE", "JPM", "SBUX"]),
                    DataFrame(reshape([0.0006662517554895613, 0.0007849399521007353,
                                       0.0009459643095974261, 0.0008592165739551059,
                                       0.0017810088172303237, -0.0005785685052765102,
                                       0.0017612947636060521, 0.0003152090009733905,
                                       0.0008537176877854478, 0.0004723791639856617,
                                       0.00023196965409296734, -0.0005054162297035769,
                                       -0.0014286220563319559, -2.5004548117932975e-5,
                                       -0.0011796361837921718, 0.0011274045369944028,
                                       0.0010443935920757378, 0.00034316200087855785,
                                       0.0008756515571520004, 0.0006211971816987232,
                                       -0.06480893184671563, 0.1265663349283534,
                                       0.06531891020282664, -0.14583770722844627,
                                       0.17384069980818687, -0.10197670562589713,
                                       0.40552722097762517, 0.15455342961953242,
                                       0.13332079577168393, -0.12914789861819334,
                                       0.011581940571448384, 0.13255382044317096,
                                       -0.13950988276499568, 0.05523327575227021,
                                       0.6196572987779644, 0.315267811840457,
                                       0.19010334905522483, 0.21814502022320065,
                                       0.1112154776675108, 0.24492867002761698,
                                       0.03621442191787694, -0.018576988118456626,
                                       -0.033527310265712554, 0.1584057759842692,
                                       -0.017135982753150397, 0.08319092183606666,
                                       0.04095160488367243, -0.02410240121837933,
                                       -0.015985518611239317, 0.042107810262914956,
                                       0.01393611737205343, 0.12788949977560324,
                                       0.3458988137936367, 0.018928053608771953,
                                       -0.12582156590453064, -0.09421231675663434,
                                       -0.036305171782130156, -0.029356961596530413,
                                       -0.017287323397846128, -0.05338133590717126,
                                       -0.11792470271706594, -0.0926516044804406,
                                       -0.19273865391548434, -0.07072481964191567,
                                       -0.02369068378021912, 0.06541829500950368,
                                       0.10382212284974576, -0.03610528820893009,
                                       0.10038297096845941, 0.2944861267239947,
                                       -0.13781284666197124, 0.14227242984111085,
                                       0.6633454725811262, -0.04694291556860392,
                                       -0.22794077702668827, -0.15181516844962,
                                       -0.03792410511305884, -0.12294081844215514,
                                       -0.0018878868853723656, -0.1704758047222016,
                                       0.007948848158307176, -0.08393429696037784,
                                       0.07199537737330614, -0.3003098369766753,
                                       -0.06347006586041148, -0.1424226191965026,
                                       -0.2637077728661142, -0.06769462315395022,
                                       -0.09084369945363698, -0.027867525155884906,
                                       -0.015004515818551027, -0.32886678334558983,
                                       -0.6425048316279028, -0.14876099197615006,
                                       -0.27397526290127255, 0.05766292663184291,
                                       -0.12371744897166051, -0.027224863873640707,
                                       -0.06472451430464957, -0.012397422303371637,
                                       0.24297761348677277, -0.02001368763315179,
                                       0.11071406987599967, 0.45782457720286435,
                                       -0.10902518568940052, 0.1455663926686262,
                                       -0.2576158884320345, -0.10364528131083903,
                                       -0.22512091315073404, -0.16102302797620519,
                                       0.17173019738912326, 0.02121767790834828,
                                       0.041927044324022895, 0.04015829407065362,
                                       -0.395095048650537, -0.19591599492039793,
                                       -0.15760355158485626, -0.04545745159216734,
                                       -0.10326507296810988, -0.06053276587733248], 20, :),
                              [:const, :MTUM, :QUAL, :VLUE, :SIZE, :USMV]))

    views_factors = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                            false],
                              "Factor" => ["MTUM", "USMV", "VLUE", "QUAL", "USMV", "MTUM",
                                           "QUAL", "VLUE", "USMV"],
                              "Sign" => ["<=", "<=", ">=", ">=", "<=", "<=", ">=", ">=",
                                         "<="],
                              "Value" => [0.9, -1.2, 0.3, -0.5, 0.7, -0.13, 0.17, -0.29,
                                          0.72],
                              "Relative_Factor" => ["", "", "", "", "MTUM", "USMV", "VLUE",
                                                    "QUAL", ""])

    f_P, f_Q = factor_views(views_factors, loadings)
    Q ./= 252
    f_Q ./= 252

    asset_statistics!(portfolio)
    bl_type = ABLType(; delta = nothing)
    black_litterman_factor_statistics!(portfolio; f_P = f_P, f_Q = f_Q, bl_type = bl_type)
    blfm_mut = [0.000603932629829369, 0.0008964903239153136, 0.0010572452079626881,
                0.0007531135364743434, 0.0017407455529343334, -0.0006815015917490989,
                0.0014873477773678552, 0.00038674925910267793, 0.0009189732413442589,
                0.0002633049581370759, 0.00021984875583947673, -0.0007698663834301626,
                -0.001982624621175092, 9.079383126372053e-5, -0.0008035072437331927,
                0.0012593268654747926, 0.0011834558420370897, 0.00029491706288983327,
                0.0009404381485761508, 0.0007661177472875124]
    blfm_covt = reshape([3.8979717043162773e-7, -3.431726017532447e-7,
                         -2.124183820924361e-7, 5.306909940997836e-7, 1.3460945758229674e-7,
                         3.8239168721995376e-7, 8.783778782749325e-7,
                         -2.1450966996546356e-7, -3.3238871516207046e-7,
                         4.6541309474874815e-7, 1.5914570829605436e-7, 8.202121167055404e-7,
                         2.206522166344819e-6, -3.7895167935688584e-7,
                         -1.217551501084486e-6, -2.7190572790842766e-7,
                         -4.944106047992983e-7, 2.1954392951465315e-7,
                         -2.876264109750786e-7, -3.0459030483092576e-7,
                         -3.431726017532447e-7, 5.089587212524212e-7, 2.448627594863385e-7,
                         -4.672137793374905e-7, -1.2678008067839353e-7,
                         -3.7345242769293586e-7, -8.272882178856485e-7,
                         3.1813893872650855e-7, 2.92630908657937e-7, -5.36499400657629e-7,
                         -1.40109910786164e-7, -7.725055891095147e-7, -2.154939783787093e-6,
                         5.620226124008212e-7, 1.8057486287785998e-6, 3.1343608872242654e-7,
                         7.332595548317432e-7, -2.06774454011171e-7, 2.5322273037042963e-7,
                         3.511128454091603e-7, -2.124183820924361e-7, 2.448627594863385e-7,
                         1.799097844994854e-7, -2.891978980580835e-7, -8.168190492104915e-8,
                         -2.4976011088953384e-7, -5.330054784162644e-7,
                         1.5305834281611764e-7, 1.8113387796632485e-7,
                         -3.941860810471907e-7, -8.67258062335424e-8, -4.977101114227023e-7,
                         -1.4411956100643483e-6, 2.7039208096813584e-7,
                         8.687553110275712e-7, 2.3029316215601628e-7, 3.5277508866373553e-7,
                         -1.3322070156657306e-7, 1.5674084242014298e-7,
                         2.5797567782463996e-7, 5.306909940997836e-7, -4.672137793374905e-7,
                         -2.891978980580835e-7, 7.225114818235439e-7, 1.8326461113237705e-7,
                         5.206087678926569e-7, 1.1958712499151228e-6,
                         -2.9204509071229907e-7, -4.5253201166586205e-7,
                         6.336386117067523e-7, 2.1666959267280242e-7, 1.116681229639496e-6,
                         3.004078866619958e-6, -5.159253547459096e-7,
                         -1.6576406025815228e-6, -3.7018719475441545e-7,
                         -6.73117393500166e-7, 2.9889900450998016e-7,
                         -3.9159018471285674e-7, -4.146857492194001e-7,
                         1.3460945758229674e-7, -1.2678008067839353e-7,
                         -8.168190492104915e-8, 1.8326461113237705e-7,
                         5.7464740414131145e-8, 1.4462610637093717e-7, 3.749792746150415e-7,
                         -7.924744902587464e-8, -1.1478447779634576e-7,
                         1.7896675315856374e-7, 5.495811436132866e-8, 3.5014832700106336e-7,
                         8.345388255159862e-7, -1.3999813573877316e-7,
                         -4.498065310254064e-7, -1.0455676008698738e-7,
                         -1.8265274105354974e-7, 9.3723243118576e-8, -9.932661934119401e-8,
                         -1.1712506268994396e-7, 3.8239168721995376e-7,
                         -3.7345242769293586e-7, -2.4976011088953384e-7,
                         5.206087678926569e-7, 1.4462610637093717e-7, 4.377255495249824e-7,
                         9.437403191347219e-7, -2.3343692533419258e-7,
                         -3.260738949517804e-7, 5.472295994764931e-7, 1.5612221053789847e-7,
                         8.812462880987643e-7, 2.5258162247805667e-6,
                         -4.1238847131480224e-7, -1.3249821273556269e-6,
                         -3.197049336547345e-7, -5.380349121582659e-7,
                         2.3588077890936868e-7, -2.8216199840573797e-7,
                         -3.5813524027946083e-7, 8.783778782749325e-7,
                         -8.272882178856485e-7, -5.330054784162644e-7,
                         1.1958712499151228e-6, 3.749792746150415e-7, 9.437403191347219e-7,
                         2.4468823034398787e-6, -5.17119728318431e-7, -7.490123493292365e-7,
                         1.1678260929404944e-6, 3.5862258680584547e-7,
                         2.2848509315526783e-6, 5.445683060171491e-6, -9.135410515824129e-7,
                         -2.9351585947424987e-6, -6.82272603530553e-7,
                         -1.191878565067614e-6, 6.115797872910189e-7, -6.481439470907884e-7,
                         -7.642855554596767e-7, -2.1450966996546356e-7,
                         3.1813893872650855e-7, 1.5305834281611764e-7,
                         -2.9204509071229907e-7, -7.924744902587464e-8,
                         -2.3343692533419258e-7, -5.17119728318431e-7,
                         1.9886167602192377e-7, 1.8291716563970793e-7,
                         -3.353540136472996e-7, -8.757963359569518e-8,
                         -4.828763080728405e-7, -1.3470056159902812e-6,
                         3.5130801376129345e-7, 1.1287338803300118e-6,
                         1.9592202758499432e-7, 4.58344472438621e-7, -1.292501780754583e-7,
                         1.5828397733969403e-7, 2.194729422004088e-7,
                         -3.3238871516207046e-7, 2.92630908657937e-7, 1.8113387796632485e-7,
                         -4.5253201166586205e-7, -1.1478447779634576e-7,
                         -3.260738949517804e-7, -7.490123493292365e-7,
                         1.8291716563970793e-7, 2.834352487602064e-7, -3.968680953019612e-7,
                         -1.357070843935607e-7, -6.994131110046368e-7,
                         -1.8815505177643713e-6, 3.231405237513492e-7,
                         1.0382332397164324e-6, 2.3186006056612195e-7, 4.215949169408624e-7,
                         -1.8720999070433393e-7, 2.452654365985167e-7,
                         2.5973092611618744e-7, 4.6541309474874815e-7, -5.36499400657629e-7,
                         -3.941860810471907e-7, 6.336386117067523e-7, 1.7896675315856374e-7,
                         5.472295994764931e-7, 1.1678260929404944e-6, -3.353540136472996e-7,
                         -3.968680953019612e-7, 8.63669905024524e-7, 1.9001804587782202e-7,
                         1.090493209500971e-6, 3.1576895672168055e-6, -5.924346751881946e-7,
                         -1.903460961814522e-6, -5.04577109771346e-7, -7.729375591129672e-7,
                         2.91889328926896e-7, -3.4342244689793377e-7, -5.65230077564681e-7,
                         1.5914570829605436e-7, -1.40109910786164e-7, -8.67258062335424e-8,
                         2.1666959267280242e-7, 5.495811436132866e-8, 1.5612221053789847e-7,
                         3.5862258680584547e-7, -8.757963359569518e-8,
                         -1.357070843935607e-7, 1.9001804587782202e-7, 6.497573197121506e-8,
                         3.348747712090843e-7, 9.008750182701403e-7, -1.5471773013259877e-7,
                         -4.970998014496782e-7, -1.1101319593948786e-7,
                         -2.0185709866189258e-7, 8.963501229640659e-8,
                         -1.1743160897920305e-7, -1.2435759794972616e-7,
                         8.202121167055404e-7, -7.725055891095147e-7, -4.977101114227023e-7,
                         1.116681229639496e-6, 3.5014832700106336e-7, 8.812462880987643e-7,
                         2.2848509315526783e-6, -4.828763080728405e-7,
                         -6.994131110046368e-7, 1.090493209500971e-6, 3.348747712090843e-7,
                         2.13354919935807e-6, 5.085072541288105e-6, -8.530468015512636e-7,
                         -2.7407938011693316e-6, -6.370928391446094e-7,
                         -1.1129529384665165e-6, 5.710812672712621e-7,
                         -6.052241659560827e-7, -7.136749327546689e-7, 2.206522166344819e-6,
                         -2.154939783787093e-6, -1.4411956100643483e-6,
                         3.004078866619958e-6, 8.345388255159862e-7, 2.5258162247805667e-6,
                         5.445683060171491e-6, -1.3470056159902812e-6,
                         -1.8815505177643713e-6, 3.1576895672168055e-6,
                         9.008750182701403e-7, 5.085072541288105e-6, 1.4574766330868242e-5,
                         -2.379613191166891e-6, -7.64557005743494e-6,
                         -1.8447995769144452e-6, -3.1046332847233843e-6,
                         1.3611074316550791e-6, -1.628164849787363e-6,
                         -2.0665547202947225e-6, -3.7895167935688584e-7,
                         5.620226124008212e-7, 2.7039208096813584e-7, -5.159253547459096e-7,
                         -1.3999813573877316e-7, -4.1238847131480224e-7,
                         -9.135410515824129e-7, 3.5130801376129345e-7, 3.231405237513492e-7,
                         -5.924346751881946e-7, -1.5471773013259877e-7,
                         -8.530468015512636e-7, -2.379613191166891e-6, 6.206189297104473e-7,
                         1.9940154659085457e-6, 3.461148459567966e-7, 8.097089869306394e-7,
                         -2.283326996249505e-7, 2.796236600327692e-7, 3.8771977055221857e-7,
                         -1.217551501084486e-6, 1.8057486287785998e-6, 8.687553110275712e-7,
                         -1.6576406025815228e-6, -4.498065310254064e-7,
                         -1.3249821273556269e-6, -2.9351585947424987e-6,
                         1.1287338803300118e-6, 1.0382332397164324e-6,
                         -1.903460961814522e-6, -4.970998014496782e-7,
                         -2.7407938011693316e-6, -7.64557005743494e-6,
                         1.9940154659085457e-6, 6.406665165926369e-6, 1.1120485096081315e-6,
                         2.6015517180240326e-6, -7.336207657050987e-7, 8.984158813847195e-7,
                         1.2457229096784274e-6, -2.7190572790842766e-7,
                         3.1343608872242654e-7, 2.3029316215601628e-7,
                         -3.7018719475441545e-7, -1.0455676008698738e-7,
                         -3.197049336547345e-7, -6.82272603530553e-7, 1.9592202758499432e-7,
                         2.3186006056612195e-7, -5.04577109771346e-7,
                         -1.1101319593948786e-7, -6.370928391446094e-7,
                         -1.8447995769144452e-6, 3.461148459567966e-7,
                         1.1120485096081315e-6, 2.9478630461077e-7, 4.5156905125721115e-7,
                         -1.7052889432218454e-7, 2.006358038857634e-7, 3.302212537851568e-7,
                         -4.944106047992983e-7, 7.332595548317432e-7, 3.5277508866373553e-7,
                         -6.73117393500166e-7, -1.8265274105354974e-7,
                         -5.380349121582659e-7, -1.191878565067614e-6, 4.58344472438621e-7,
                         4.215949169408624e-7, -7.729375591129672e-7,
                         -2.0185709866189258e-7, -1.1129529384665165e-6,
                         -3.1046332847233843e-6, 8.097089869306394e-7,
                         2.6015517180240326e-6, 4.5156905125721115e-7,
                         1.0564109667480499e-6, -2.9790106302896634e-7,
                         3.6481934347834355e-7, 5.058501563489227e-7, 2.1954392951465315e-7,
                         -2.06774454011171e-7, -1.3322070156657306e-7,
                         2.9889900450998016e-7, 9.3723243118576e-8, 2.3588077890936868e-7,
                         6.115797872910189e-7, -1.292501780754583e-7,
                         -1.8720999070433393e-7, 2.91889328926896e-7, 8.963501229640659e-8,
                         5.710812672712621e-7, 1.3611074316550791e-6, -2.283326996249505e-7,
                         -7.336207657050987e-7, -1.7052889432218454e-7,
                         -2.9790106302896634e-7, 1.528597577815071e-7,
                         -1.619986939048463e-7, -1.9102741344811875e-7,
                         -2.876264109750786e-7, 2.5322273037042963e-7,
                         1.5674084242014298e-7, -3.9159018471285674e-7,
                         -9.932661934119401e-8, -2.8216199840573797e-7,
                         -6.481439470907884e-7, 1.5828397733969403e-7, 2.452654365985167e-7,
                         -3.4342244689793377e-7, -1.1743160897920305e-7,
                         -6.052241659560827e-7, -1.628164849787363e-6, 2.796236600327692e-7,
                         8.984158813847195e-7, 2.006358038857634e-7, 3.6481934347834355e-7,
                         -1.619986939048463e-7, 2.1223589745139346e-7,
                         2.2475334056273972e-7, -3.0459030483092576e-7,
                         3.511128454091603e-7, 2.5797567782463996e-7, -4.146857492194001e-7,
                         -1.1712506268994396e-7, -3.5813524027946083e-7,
                         -7.642855554596767e-7, 2.194729422004088e-7, 2.5973092611618744e-7,
                         -5.65230077564681e-7, -1.2435759794972616e-7,
                         -7.136749327546689e-7, -2.0665547202947225e-6,
                         3.8771977055221857e-7, 1.2457229096784274e-6, 3.302212537851568e-7,
                         5.058501563489227e-7, -1.9102741344811875e-7,
                         2.2475334056273972e-7, 3.699156804304098e-7], (20, 20))
    @test isapprox(blfm_mut, portfolio.blfm_mu)
    @test isapprox(blfm_covt, portfolio.blfm_cov)

    asset_sets = DataFrame("Asset" => portfolio.assets,
                           "PDBHT" => [1, 2, 1, 1, 1, 3, 2, 2, 3, 3, 3, 4, 4, 3, 3, 4, 2, 2,
                                       3, 1],
                           "SPDBHT" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 3, 3, 2, 3, 3, 3, 3, 1,
                                        4, 2, 1],
                           "Pward" => [1, 1, 1, 1, 1, 2, 3, 2, 2, 2, 2, 4, 4, 2, 3, 4, 1, 2,
                                       2, 1],
                           "SPward" => [1, 1, 1, 1, 1, 2, 2, 3, 2, 2, 2, 4, 3, 2, 2, 3, 1,
                                        2, 2, 1],
                           "G2DBHT" => [1, 2, 1, 1, 1, 3, 2, 3, 4, 3, 4, 3, 3, 4, 4, 3, 2,
                                        3, 4, 1],
                           "G2ward" => [1, 1, 1, 1, 1, 2, 3, 4, 2, 2, 4, 2, 3, 3, 3, 2, 1,
                                        4, 2, 2])
    views_assets = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           true, true, true, true, true, true, true, true,
                                           false],
                             "Type" => ["Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Asset", "Asset", "Asset",
                                        "Asset", "Asset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Subset",
                                        "Subset", "Subset", "Subset", "Subset", "Asset"],
                             "Set" => ["", "", "", "", "", "", "", "", "", "", "", "",
                                       "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT", "PDBHT",
                                       "Pward", "Pward", "Pward", "Pward", "SPward",
                                       "SPward", ""],
                             "Position" => ["GE", "SBUX", "BABA", "SHLD", "FB", "WMT",
                                            "UAA", "XOM", "UAA", "AMD", "BBY", "FB", 1, 3,
                                            4, 2, 1, 3, 1, 3, 2, 1, 3, 2, "GOOG"],
                             "Sign" => [">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">=", ">=", "<=", "<=", ">=", ">=", "<=", "<=",
                                        ">="],
                             "Return" => [0.3, -0.2, 2.3, -0.7, 0.17, -0.11, 0.13, -0.23,
                                          0.5, -0.37, 0.23, 5.1, 0.27, -0.31, 0.41, -0.19,
                                          0.03, -0.29, 0.71, -0.41, 0.61, -0.019, 1.7, -2.3,
                                          0.69],
                             "Relative_Type" => ["", "", "", "", "Asset", "Asset", "Asset",
                                                 "Asset", "Subset", "Subset", "Subset",
                                                 "Subset", "", "", "", "", "Asset", "Asset",
                                                 "Asset", "Asset", "Subset", "Subset",
                                                 "Subset", "Subset", ""],
                             "Relative_Position" => ["", "", "", "", "GOOG", "AMD", "MA",
                                                     "BAC", 3, 2, 4, 2, "", "", "", "",
                                                     "AAPL", "GE", "PFE", "RRC", 3, 3, 2, 3,
                                                     ""],
                             "Relative_Set" => ["", "", "", "", "", "", "", "", "PDBHT",
                                                "PDBHT", "Pward", "Pward", "", "", "", "",
                                                "", "", "", "", "PDBHT", "Pward", "SPward",
                                                "Pward", ""])

    P, Q = asset_views(views_assets, asset_sets)

    loadings = hcat(DataFrame(:tickers => ["GOOG", "AAPL", "FB", "BABA", "AMZN", "GE",
                                           "AMD", "WMT", "BAC", "GM", "T", "UAA", "SHLD",
                                           "XOM", "RRC", "BBY", "MA", "PFE", "JPM", "SBUX"]),
                    DataFrame(reshape([0.0006662517554895613, 0.0007849399521007353,
                                       0.0009459643095974261, 0.0008592165739551059,
                                       0.0017810088172303237, -0.0005785685052765102,
                                       0.0017612947636060521, 0.0003152090009733905,
                                       0.0008537176877854478, 0.0004723791639856617,
                                       0.00023196965409296734, -0.0005054162297035769,
                                       -0.0014286220563319559, -2.5004548117932975e-5,
                                       -0.0011796361837921718, 0.0011274045369944028,
                                       0.0010443935920757378, 0.00034316200087855785,
                                       0.0008756515571520004, 0.0006211971816987232,
                                       -0.06480893184671563, 0.1265663349283534,
                                       0.06531891020282664, -0.14583770722844627,
                                       0.17384069980818687, -0.10197670562589713,
                                       0.40552722097762517, 0.15455342961953242,
                                       0.13332079577168393, -0.12914789861819334,
                                       0.011581940571448384, 0.13255382044317096,
                                       -0.13950988276499568, 0.05523327575227021,
                                       0.6196572987779644, 0.315267811840457,
                                       0.19010334905522483, 0.21814502022320065,
                                       0.1112154776675108, 0.24492867002761698,
                                       0.03621442191787694, -0.018576988118456626,
                                       -0.033527310265712554, 0.1584057759842692,
                                       -0.017135982753150397, 0.08319092183606666,
                                       0.04095160488367243, -0.02410240121837933,
                                       -0.015985518611239317, 0.042107810262914956,
                                       0.01393611737205343, 0.12788949977560324,
                                       0.3458988137936367, 0.018928053608771953,
                                       -0.12582156590453064, -0.09421231675663434,
                                       -0.036305171782130156, -0.029356961596530413,
                                       -0.017287323397846128, -0.05338133590717126,
                                       -0.11792470271706594, -0.0926516044804406,
                                       -0.19273865391548434, -0.07072481964191567,
                                       -0.02369068378021912, 0.06541829500950368,
                                       0.10382212284974576, -0.03610528820893009,
                                       0.10038297096845941, 0.2944861267239947,
                                       -0.13781284666197124, 0.14227242984111085,
                                       0.6633454725811262, -0.04694291556860392,
                                       -0.22794077702668827, -0.15181516844962,
                                       -0.03792410511305884, -0.12294081844215514,
                                       -0.0018878868853723656, -0.1704758047222016,
                                       0.007948848158307176, -0.08393429696037784,
                                       0.07199537737330614, -0.3003098369766753,
                                       -0.06347006586041148, -0.1424226191965026,
                                       -0.2637077728661142, -0.06769462315395022,
                                       -0.09084369945363698, -0.027867525155884906,
                                       -0.015004515818551027, -0.32886678334558983,
                                       -0.6425048316279028, -0.14876099197615006,
                                       -0.27397526290127255, 0.05766292663184291,
                                       -0.12371744897166051, -0.027224863873640707,
                                       -0.06472451430464957, -0.012397422303371637,
                                       0.24297761348677277, -0.02001368763315179,
                                       0.11071406987599967, 0.45782457720286435,
                                       -0.10902518568940052, 0.1455663926686262,
                                       -0.2576158884320345, -0.10364528131083903,
                                       -0.22512091315073404, -0.16102302797620519,
                                       0.17173019738912326, 0.02121767790834828,
                                       0.041927044324022895, 0.04015829407065362,
                                       -0.395095048650537, -0.19591599492039793,
                                       -0.15760355158485626, -0.04545745159216734,
                                       -0.10326507296810988, -0.06053276587733248], 20, :),
                              [:const, :MTUM, :QUAL, :VLUE, :SIZE, :USMV]))

    views_factors = DataFrame("Enabled" => [true, true, true, true, true, true, true, true,
                                            false],
                              "Factor" => ["MTUM", "USMV", "VLUE", "QUAL", "USMV", "MTUM",
                                           "QUAL", "VLUE", "USMV"],
                              "Sign" => ["<=", "<=", ">=", ">=", "<=", "<=", ">=", ">=",
                                         "<="],
                              "Value" => [0.9, -1.2, 0.3, -0.5, 0.7, -0.13, 0.17, -0.29,
                                          0.72],
                              "Relative_Factor" => ["", "", "", "", "MTUM", "USMV", "VLUE",
                                                    "QUAL", ""])

    f_P, f_Q = factor_views(views_factors, loadings)
    Q ./= 252
    f_Q ./= 252

    asset_statistics!(portfolio)
    bl_type = ABLType(; delta = nothing)
    black_litterman_factor_statistics!(portfolio; P = P, Q = Q, f_P = f_P, f_Q = f_Q,
                                       bl_type = bl_type)
    blfm_mut = [0.004021061243001632, 0.0029024489093301955, 0.007924586475317387,
                0.005003799073505964, 0.00433341373838738, -0.0013842148732269247,
                0.003500502103245526, 0.0008377051470300815, -0.0013184348142208696,
                -0.001740741924383664, -0.0009692127730359023, 0.00029053097902623237,
                8.993301139156038e-5, -0.0019880951989138234, -0.0028679691532814593,
                0.0028529517152343998, 0.0017964020850009478, 7.175605748069324e-6,
                -0.0012062760197457485, 0.0008177128988764878]
    blfm_covt = reshape([0.00021008242663586428, 9.807203686251982e-5,
                         0.00014082912936160823, 0.00011823736670584443,
                         0.0001584438080165881, 6.204152353663993e-5, 8.225884432062558e-5,
                         4.179073863401433e-5, 9.059594061723789e-5, 7.167588590946058e-5,
                         4.032113582553683e-5, 0.00010232423765429867, 3.584196552777078e-5,
                         5.3340163902034774e-5, 2.4497074001484115e-5, 5.0093301060117e-5,
                         9.855535871461649e-5, 5.8961960116020006e-5, 7.893911535363605e-5,
                         8.309628842268033e-5, 9.807203686251982e-5, 0.00021162576436259848,
                         0.00010918353108034984, 9.462124604765267e-5,
                         0.00010731803835081107, 5.81963362976921e-5,
                         0.00013025281844439727, 4.5509381509922206e-5,
                         9.434577857344591e-5, 7.58969383813684e-5, 4.180166464021972e-5,
                         9.136266396966368e-5, 7.145297615910722e-5, 5.894399428409686e-5,
                         5.414839277944192e-5, 7.434760516134905e-5, 9.260860971013017e-5,
                         5.098204266879314e-5, 8.57157123409817e-5, 7.164332468437307e-5,
                         0.00014082912936160823, 0.00010918353108034984,
                         0.0002573379984522393, 0.00011934638549390776,
                         0.0001533770451860179, 6.706673808229154e-5, 0.0001170975804285368,
                         3.865880365426136e-5, 9.449443386582381e-5, 7.614745580888926e-5,
                         3.901256198445561e-5, 0.00013795481596561105, 5.835534826885078e-5,
                         5.249688288885917e-5, 4.339954979425674e-5, 5.646737950947118e-5,
                         0.00010169667837467892, 5.427168584638293e-5, 8.136178942725956e-5,
                         8.804049362882074e-5, 0.00011823736670584443, 9.462124604765267e-5,
                         0.00011934638549390776, 0.0004008075943515589,
                         0.00013259891533724696, 6.512187148835825e-5, 0.000200690718124518,
                         3.465428308001138e-5, 9.788225510768839e-5, 8.157488782051642e-5,
                         2.8584581823697087e-5, 0.00011093801938475152,
                         0.00010046612127424615, 5.63333583673862e-5, 9.640402557885828e-5,
                         7.791954835627904e-5, 0.00010095085828985355,
                         5.2246172769244204e-5, 8.448873368975027e-5, 6.915270600688783e-5,
                         0.0001584438080165881, 0.00010731803835081107,
                         0.0001533770451860179, 0.00013259891533724696,
                         0.0003313174473119676, 5.165264086615645e-5,
                         0.00012078511547295757, 3.68176396440601e-5, 8.816351582989359e-5,
                         6.596889943627257e-5, 3.729897300786393e-5, 0.00011920439257565519,
                         1.943458202805139e-5, 5.1224771619874505e-5, 7.752322895334089e-5,
                         5.711682232779629e-5, 0.00010451533761260555, 4.647315888023727e-5,
                         7.525154218700027e-5, 9.988755250262608e-5, 6.204152353663993e-5,
                         5.81963362976921e-5, 6.706673808229154e-5, 6.512187148835825e-5,
                         5.165264086615645e-5, 0.00017915188426698386, 9.457595491467252e-5,
                         3.829710681372504e-5, 9.964731234378231e-5, 8.682495507353596e-5,
                         5.27895911153156e-5, 0.00010674624125996907,
                         0.00011518495634364299, 6.948733235833635e-5,
                         0.00010070797078075068, 4.771816205258511e-5, 6.472532875869734e-5,
                         5.618243476971333e-5, 9.131335955805772e-5, 6.142597747897933e-5,
                         8.225884432062558e-5, 0.00013025281844439727,
                         0.0001170975804285368, 0.000200690718124518,
                         0.00012078511547295757, 9.457595491467252e-5, 0.001648527623903547,
                         4.5198807065488065e-5, 0.00016774272200947295,
                         0.00013860173170430332, 6.448566537897797e-5,
                         0.00010583431954774915, 0.00014003459893727942,
                         8.969645111327169e-5, 0.00024081133386454152,
                         0.00012003177705149344, 0.00013060332157473445,
                         7.416246940323911e-5, 0.00012603862864857325, 5.355991071623345e-5,
                         4.179073863401433e-5, 4.5509381509922206e-5, 3.865880365426136e-5,
                         3.465428308001138e-5, 3.68176396440601e-5, 3.829710681372504e-5,
                         4.5198807065488065e-5, 0.0001636624531144898, 4.141153649074649e-5,
                         4.9840888284367513e-5, 4.2414781937464035e-5, 6.408034497815666e-5,
                         0.00011170631180755455, 3.451965571677064e-5,
                         2.0883338493994962e-5, 5.776486551453856e-5, 4.602626150481877e-5,
                         4.4512734354178646e-5, 4.7252468169620626e-5,
                         4.8778908888863666e-5, 9.059594061723789e-5, 9.434577857344591e-5,
                         9.449443386582381e-5, 9.788225510768839e-5, 8.816351582989359e-5,
                         9.964731234378231e-5, 0.00016774272200947295, 4.141153649074649e-5,
                         0.00027632578716766634, 0.00012586482052030624,
                         4.6750119717739084e-5, 0.00014177272801642733,
                         0.0001484726098268256, 9.144975064348883e-5,
                         0.00013536730497331015, 0.00011847545687790945,
                         0.00010988581663414687, 7.75920459711067e-5,
                         0.00020126255486107425, 7.78948304010152e-5, 7.167588590946058e-5,
                         7.58969383813684e-5, 7.614745580888926e-5, 8.157488782051642e-5,
                         6.596889943627257e-5, 8.682495507353596e-5, 0.00013860173170430332,
                         4.9840888284367513e-5, 0.00012586482052030624,
                         0.0002435025771171761, 4.7662036263663444e-5,
                         0.0001282135475628083, 0.0001457677828384978, 6.566439686611156e-5,
                         0.00010408904871862673, 0.00010009015352460282,
                         7.693168946685397e-5, 6.023282077308315e-5, 0.00010820015002671132,
                         6.992090001861525e-5, 4.032113582553683e-5, 4.180166464021972e-5,
                         3.901256198445561e-5, 2.8584581823697087e-5, 3.729897300786393e-5,
                         5.27895911153156e-5, 6.448566537897797e-5, 4.2414781937464035e-5,
                         4.6750119717739084e-5, 4.7662036263663444e-5,
                         0.00010544146567456198, 4.888977579137969e-5, 5.890281927253267e-5,
                         4.85469983957869e-5, 6.256447941205226e-5, 4.0319790524481885e-5,
                         4.266195914498391e-5, 3.728599920621928e-5, 5.142210597004043e-5,
                         3.609080444995472e-5, 0.00010232423765429867, 9.136266396966368e-5,
                         0.00013795481596561105, 0.00011093801938475152,
                         0.00011920439257565519, 0.00010674624125996907,
                         0.00010583431954774915, 6.408034497815666e-5,
                         0.00014177272801642733, 0.0001282135475628083,
                         4.888977579137969e-5, 0.0007069289913037739,
                         0.00023016125848818316, 7.572614684852925e-5,
                         0.0001305571524896454, 0.0001375826046880437, 9.304388799924792e-5,
                         6.831664100144845e-5, 0.00012186271448409844,
                         0.00010813235407728808, 3.584196552777078e-5, 7.145297615910722e-5,
                         5.835534826885078e-5, 0.00010046612127424615, 1.943458202805139e-5,
                         0.00011518495634364299, 0.00014003459893727942,
                         0.00011170631180755455, 0.0001484726098268256,
                         0.0001457677828384978, 5.890281927253267e-5,
                         0.00023016125848818316, 0.0019445702916361732,
                         7.833582223073052e-5, 0.00022168361877733, 0.00023389559140511796,
                         5.9640292433200334e-5, 5.5871754091256325e-5,
                         0.00010027343522732782, 9.470179695064269e-5,
                         5.3340163902034774e-5, 5.894399428409686e-5, 5.249688288885917e-5,
                         5.63333583673862e-5, 5.1224771619874505e-5, 6.948733235833635e-5,
                         8.969645111327169e-5, 3.451965571677064e-5, 9.144975064348883e-5,
                         6.566439686611156e-5, 4.85469983957869e-5, 7.572614684852925e-5,
                         7.833582223073052e-5, 0.00014372437522447483,
                         0.00015456114536260016, 4.731090459252036e-5, 6.446450663116916e-5,
                         5.126757177525455e-5, 8.778137744890787e-5, 4.016717312870028e-5,
                         2.4497074001484115e-5, 5.414839277944192e-5, 4.339954979425674e-5,
                         9.640402557885828e-5, 7.752322895334089e-5, 0.00010070797078075068,
                         0.00024081133386454152, 2.0883338493994962e-5,
                         0.00013536730497331015, 0.00010408904871862673,
                         6.256447941205226e-5, 0.0001305571524896454, 0.00022168361877733,
                         0.00015456114536260016, 0.0009940279156508153,
                         0.00011452345924075061, 6.704807286235318e-5, 3.765142495268782e-5,
                         0.0001163698217289361, 3.5146257675202375e-5, 5.0093301060117e-5,
                         7.434760516134905e-5, 5.646737950947118e-5, 7.791954835627904e-5,
                         5.711682232779629e-5, 4.771816205258511e-5, 0.00012003177705149344,
                         5.776486551453856e-5, 0.00011847545687790945,
                         0.00010009015352460282, 4.0319790524481885e-5,
                         0.0001375826046880437, 0.00023389559140511796,
                         4.731090459252036e-5, 0.00011452345924075061,
                         0.0005057528304723668, 7.481434161442648e-5, 4.9322051856097764e-5,
                         9.259391082338708e-5, 7.638890119284855e-5, 9.855535871461649e-5,
                         9.260860971013017e-5, 0.00010169667837467892,
                         0.00010095085828985355, 0.00010451533761260555,
                         6.472532875869734e-5, 0.00013060332157473445, 4.602626150481877e-5,
                         0.00010988581663414687, 7.693168946685397e-5, 4.266195914498391e-5,
                         9.304388799924792e-5, 5.9640292433200334e-5, 6.446450663116916e-5,
                         6.704807286235318e-5, 7.481434161442648e-5, 0.000162537076063034,
                         6.130290803463067e-5, 9.841321001666143e-5, 7.737470425211579e-5,
                         5.8961960116020006e-5, 5.098204266879314e-5, 5.427168584638293e-5,
                         5.2246172769244204e-5, 4.647315888023727e-5, 5.618243476971333e-5,
                         7.416246940323911e-5, 4.4512734354178646e-5, 7.75920459711067e-5,
                         6.023282077308315e-5, 3.728599920621928e-5, 6.831664100144845e-5,
                         5.5871754091256325e-5, 5.126757177525455e-5, 3.765142495268782e-5,
                         4.9322051856097764e-5, 6.130290803463067e-5,
                         0.00012209562465049953, 7.237920713154163e-5, 4.459150861808339e-5,
                         7.893911535363605e-5, 8.57157123409817e-5, 8.136178942725956e-5,
                         8.448873368975027e-5, 7.525154218700027e-5, 9.131335955805772e-5,
                         0.00012603862864857325, 4.7252468169620626e-5,
                         0.00020126255486107425, 0.00010820015002671132,
                         5.142210597004043e-5, 0.00012186271448409844,
                         0.00010027343522732782, 8.778137744890787e-5,
                         0.0001163698217289361, 9.259391082338708e-5, 9.841321001666143e-5,
                         7.237920713154163e-5, 0.0001849931968427554, 7.091108193236695e-5,
                         8.309628842268033e-5, 7.164332468437307e-5, 8.804049362882074e-5,
                         6.915270600688783e-5, 9.988755250262608e-5, 6.142597747897933e-5,
                         5.355991071623345e-5, 4.8778908888863666e-5, 7.78948304010152e-5,
                         6.992090001861525e-5, 3.609080444995472e-5, 0.00010813235407728808,
                         9.470179695064269e-5, 4.016717312870028e-5, 3.5146257675202375e-5,
                         7.638890119284855e-5, 7.737470425211579e-5, 4.459150861808339e-5,
                         7.091108193236695e-5, 0.00015796217699983993], (20, 20))
    @test isapprox(blfm_mut, portfolio.blfm_mu)
    @test isapprox(blfm_covt, portfolio.blfm_cov)
end
