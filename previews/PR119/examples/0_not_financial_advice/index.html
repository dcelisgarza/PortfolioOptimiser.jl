<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example 0: Not financial advice · PortfolioOptimiser.jl</title><meta name="title" content="Example 0: Not financial advice · PortfolioOptimiser.jl"/><meta property="og:title" content="Example 0: Not financial advice · PortfolioOptimiser.jl"/><meta property="twitter:title" content="Example 0: Not financial advice · PortfolioOptimiser.jl"/><meta name="description" content="Documentation for PortfolioOptimiser.jl."/><meta property="og:description" content="Documentation for PortfolioOptimiser.jl."/><meta property="twitter:description" content="Documentation for PortfolioOptimiser.jl."/><meta property="og:url" content="https://dcelisgarza.github.io/PortfolioOptimiser.jl/examples/0_not_financial_advice/"/><meta property="twitter:url" content="https://dcelisgarza.github.io/PortfolioOptimiser.jl/examples/0_not_financial_advice/"/><link rel="canonical" href="https://dcelisgarza.github.io/PortfolioOptimiser.jl/examples/0_not_financial_advice/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="PortfolioOptimiser.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">PortfolioOptimiser.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Example 0: Not financial advice</a><ul class="internal"><li><a class="tocitem" href="#0.1-Downloading-the-data"><span>0.1 Downloading the data</span></a></li><li><a class="tocitem" href="#0.2-Filter-worst-stocks"><span>0.2 Filter worst stocks</span></a></li></ul></li><li><a class="tocitem" href="../1_basic_use/">Example 1: Basic use</a></li><li><a class="tocitem" href="../2_asset_statistics/">Example 2: Asset statistics</a></li><li><a class="tocitem" href="../3_shorting_portfolios/">Example 3: Shorting and leveraged portfolios</a></li><li><a class="tocitem" href="../4_hrp_portfolios/">Example 4: Hierarchical risk parity</a></li><li><a class="tocitem" href="../5_risk_parity_portfolios/">Example 5: Risk parity</a></li><li><a class="tocitem" href="../6_worst_case_mv_portfolios/">Example 6: Worst case Mean-Variance</a></li><li><a class="tocitem" href="../7_worst_case_statistics/">Example 7: Worst case statistics</a></li><li><a class="tocitem" href="../8_relaxed_risk_parity_variance_portfolios/">-</a></li></ul></li><li><span class="tocitem">API</span><ul><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Constraints</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Constraints/WeightConstraints/">Weight constraints</a></li><li><a class="tocitem" href="../../Constraints/ViewsConstraints/">Views constraints</a></li><li><a class="tocitem" href="../../Constraints/NetworkConstraints/">Network constraints</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Parameter Estimation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ParameterEstimation/PosdefFix/">Fixing non-positive definite matrices</a></li><li><a class="tocitem" href="../../ParameterEstimation/MatrixDenoising/">Matrix denoising</a></li><li><a class="tocitem" href="../../ParameterEstimation/DistanceMatrices/">Distance matrices</a></li><li><a class="tocitem" href="../../ParameterEstimation/Clustering/">Clustering</a></li><li><a class="tocitem" href="../../ParameterEstimation/CovCorKurtSkew/">Covariance, correlation, cokurtosis and coskewness</a></li><li><a class="tocitem" href="../../ParameterEstimation/MeanEstimators/">Expected returns</a></li><li><a class="tocitem" href="../../ParameterEstimation/WorstCase/">Worst case mean variance sets</a></li><li><a class="tocitem" href="../../ParameterEstimation/Regression/">Regression</a></li><li><a class="tocitem" href="../../ParameterEstimation/BlackLitterman/">Black Litterman models</a></li><li><a class="tocitem" href="../../ParameterEstimation/OWA/">Ordered Weight Arrays</a></li><li><a class="tocitem" href="../../ParameterEstimation/ParameterEstimationMisc/">Miscelaneous</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">(HC)Portfolio</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Portfolio/PortfolioTypes/">Types</a></li><li><a class="tocitem" href="../../Portfolio/PortfolioStatistics/">Statistics</a></li><li><a class="tocitem" href="../../Portfolio/PortfolioRisk/">Risk</a></li><li><a class="tocitem" href="../../Portfolio/PortfolioClustering/">Clustering</a></li><li><a class="tocitem" href="../../Portfolio/PortfolioNetwork/">Network</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Risk Measures</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../RiskMeasures/RiskMeasures/">Risk measaures</a></li><li><a class="tocitem" href="../../RiskMeasures/RiskMeasureStatistics/">Statistics</a></li><li><a class="tocitem" href="../../RiskMeasures/MiscRiskMeasureFunctions/">Miscelaneous</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Optimisation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Optimisation/OptimisationKinds/">Optimisation kinds</a></li><li><a class="tocitem" href="../../Optimisation/ObjectiveFunctions/">Objective functions</a></li><li><a class="tocitem" href="../../Optimisation/PortfolioClasses/">Portfolio classes</a></li><li><a class="tocitem" href="../../Optimisation/AssetAllocation/">Asset allocation</a></li><li><a class="tocitem" href="../../Optimisation/OptimisationConstraints/">Constraints</a></li><li><a class="tocitem" href="../../Optimisation/OptimisationSetup/">Setup functions</a></li><li><a class="tocitem" href="../../Optimisation/OptimisationRiskMeasures/">Risk measures</a></li><li><a class="tocitem" href="../../Optimisation/OptimisationGetZ/">Entropic and relativistic moments</a></li><li><a class="tocitem" href="../../Optimisation/OptimisationFinalisation/">Finalisation functions</a></li></ul></li><li><a class="tocitem" href="../../PlotsExtension/">Plots Extension</a></li><li><a class="tocitem" href="../../References/">References</a></li><li><a class="tocitem" href="../../Contents/">Index</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Example 0: Not financial advice</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example 0: Not financial advice</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/dcelisgarza/PortfolioOptimiser.jl/blob/main/examples/0_not_financial_advice.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p>The source files for all examples can be found in <a href="https://github.com/dcelisgarza/PortfolioOptimiser.jl/tree/main/examples/">/examples</a>.</p><h1 id="Example-0:-Not-financial-advice"><a class="docs-heading-anchor" href="#Example-0:-Not-financial-advice">Example 0: Not financial advice</a><a id="Example-0:-Not-financial-advice-1"></a><a class="docs-heading-anchor-permalink" href="#Example-0:-Not-financial-advice" title="Permalink"></a></h1><p>This example goes over a sample workflow using <a href="https://github.com/dcelisgarza/PortfolioOptimiser.jl/"><code>PortfolioOptimiser.jl</code></a>. I use a similar strategy myself. This is just an example of the things that can be done with the library.</p><h2 id="0.1-Downloading-the-data"><a class="docs-heading-anchor" href="#0.1-Downloading-the-data">0.1 Downloading the data</a><a id="0.1-Downloading-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#0.1-Downloading-the-data" title="Permalink"></a></h2><p><a href="https://github.com/dcelisgarza/PortfolioOptimiser.jl"><code>PortfolioOptimiser</code></a> does not ship with supporting packages that are not integral to its internal functionality. This means users are responsible for installing packages to load and download data, <a href="https://jump.dev/JuMP.jl/stable/installation/#Supported-solvers"><code>JuMP</code></a>-compatible solvers, pretty printing, and the plotting functionality is an extension which requires <a href="https://github.com/JuliaPlots/GraphRecipes.jl"><code>GraphRecipes</code></a> and <a href="https://github.com/JuliaPlots/StatsPlots.jl"><code>StatsPlots</code></a>.</p><p>Which means we need a few extra packages to be installed. Uncomment the first two lines if these packages are not in your Julia environment.</p><pre><code class="language-julia hljs"># using Pkg
# Pkg.add.([&quot;StatsPlots&quot;, &quot;GraphRecipes&quot;, &quot;YFinance&quot;, &quot;Clarabel&quot;, &quot;HiGHS&quot;, &quot;PrettyTables&quot;])
using Clarabel, DataFrames, Dates, GraphRecipes, HiGHS, YFinance, PortfolioOptimiser,
      PrettyTables, Statistics, StatsBase, StatsPlots, TimeSeries

# These are helper functions for formatting tables.
fmt1 = (v, i, j) -&gt; begin
    if j == 1
        return v
    else
        return isa(v, Number) ? &quot;$(round(v*100, digits=3)) %&quot; : v
    end
end;
fmt2 = (v, i, j) -&gt; begin
    if j != 5
        return v
    else
        return isa(v, Number) ? &quot;$(round(v*100, digits=3)) %&quot; : v
    end
end;</code></pre><p>We define our list of meme stonks and a generous date range. We will only be keeping the adjusted close price. In practice it doesn&#39;t really matter because we&#39;re using daily data.</p><pre><code class="language-julia hljs">function stock_price_to_time_array(x)
    coln = collect(keys(x))[3:end] # only get the keys that are not ticker or datetime
    m = hcat([x[k] for k ∈ coln]...) #Convert the dictionary into a matrix
    return TimeArray(x[&quot;timestamp&quot;], m, Symbol.(coln), x[&quot;ticker&quot;])
end

assets = [&quot;AAL&quot;, &quot;AAPL&quot;, &quot;AMC&quot;, &quot;BB&quot;, &quot;BBY&quot;, &quot;DELL&quot;, &quot;DG&quot;, &quot;DRS&quot;, &quot;GME&quot;, &quot;INTC&quot;, &quot;LULU&quot;,
          &quot;MARA&quot;, &quot;MCI&quot;, &quot;MSFT&quot;, &quot;NKLA&quot;, &quot;NVAX&quot;, &quot;NVDA&quot;, &quot;PARA&quot;, &quot;PLNT&quot;, &quot;SAVE&quot;, &quot;SBUX&quot;,
          &quot;SIRI&quot;, &quot;STX&quot;, &quot;TLRY&quot;, &quot;TSLA&quot;]
Date_0 = &quot;2019-01-01&quot;
Date_1 = &quot;2023-01-01&quot;
prices = get_prices.(assets; startdt = Date_0, enddt = Date_1)
prices = stock_price_to_time_array.(prices)
prices = hcat(prices...)
cidx = colnames(prices)[occursin.(r&quot;adj&quot;, string.(colnames(prices)))]
prices = prices[cidx]
TimeSeries.rename!(prices, Symbol.(assets))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1008×25 TimeSeries.TimeArray{Float64, 2, Dates.DateTime, Matrix{Float64}} 2019-01-02T14:30:00 to 2022-12-30T14:30:00
┌─────────────────────┬─────────┬─────────┬─────────┬──────┬─────────┬──────────
│<span class="sgr1">                     </span>│<span class="sgr1"> AAL     </span>│<span class="sgr1"> AAPL    </span>│<span class="sgr1"> AMC     </span>│<span class="sgr1"> BB   </span>│<span class="sgr1"> BBY     </span>│<span class="sgr1"> DELL   </span> ⋯
├─────────────────────┼─────────┼─────────┼─────────┼──────┼─────────┼──────────
│ 2019-01-02T14:30:00 │ 31.9632 │ 37.7501 │ 119.143 │ 7.11 │ 43.6631 │ 22.2917 ⋯
│ 2019-01-03T14:30:00 │ 29.5817 │ 33.9899 │ 120.715 │ 6.88 │  42.767 │ 21.3503 ⋯
│ 2019-01-04T14:30:00 │ 31.5302 │ 35.4409 │ 125.151 │ 7.23 │ 42.9707 │ 21.7713 ⋯
│ 2019-01-07T14:30:00 │ 32.4257 │  35.362 │ 130.512 │ 7.43 │ 45.4226 │ 21.9133 ⋯
│ 2019-01-08T14:30:00 │ 31.9041 │ 36.0361 │ 134.672 │ 7.41 │ 46.7586 │ 22.1735 ⋯
│ 2019-01-09T14:30:00 │ 32.8882 │ 36.6481 │ 128.941 │ 7.47 │ 47.1089 │ 22.2066 ⋯
│ 2019-01-10T14:30:00 │ 31.5302 │ 36.7652 │ 126.907 │ 7.52 │ 46.3269 │ 21.3787 ⋯
│ 2019-01-11T14:30:00 │  31.294 │ 36.4043 │  129.68 │ 7.57 │ 46.0336 │ 21.0381 ⋯
│          ⋮          │    ⋮    │    ⋮    │    ⋮    │  ⋮   │    ⋮    │    ⋮    ⋱
│ 2022-12-21T14:30:00 │   13.03 │ 134.188 │    53.0 │ 3.75 │ 74.3655 │ 37.4134 ⋯
│ 2022-12-22T14:30:00 │   12.56 │ 130.998 │    49.1 │ 3.43 │ 74.2087 │ 37.4326 ⋯
│ 2022-12-23T14:30:00 │   12.71 │ 130.631 │    44.0 │  3.4 │ 75.0295 │ 37.4134 ⋯
│ 2022-12-27T14:30:00 │   12.53 │ 128.818 │    40.3 │ 3.29 │ 75.4999 │ 37.6908 ⋯
│ 2022-12-28T14:30:00 │   12.32 │ 124.866 │    38.4 │ 3.18 │ 73.9412 │ 37.0691 ⋯
│ 2022-12-29T14:30:00 │    12.7 │ 128.402 │    41.4 │ 3.26 │ 74.9281 │ 38.0829 ⋯
│ 2022-12-30T14:30:00 │   12.72 │ 128.719 │    40.7 │ 3.26 │ 73.9781 │ 38.4654 ⋯
└─────────────────────┴─────────┴─────────┴─────────┴──────┴─────────┴──────────
<span class="sgr36">                                                 19 columns and 993 rows omitted</span></code></pre><h2 id="0.2-Filter-worst-stocks"><a class="docs-heading-anchor" href="#0.2-Filter-worst-stocks">0.2 Filter worst stocks</a><a id="0.2-Filter-worst-stocks-1"></a><a class="docs-heading-anchor-permalink" href="#0.2-Filter-worst-stocks" title="Permalink"></a></h2><p>If we have hundreds or thousands of stocks, we should probably do some pruning of the worst stocks using a cheap method. For this we&#39;ll use the <a href="../../Optimisation/OptimisationKinds/#PortfolioOptimiser.HERC"><code>HERC</code></a> optimisation type. We&#39;ll filter the stocks using a few different risk measures. The order matters here, as each risk measure will filter out the worst performing stocks for each iteration.</p><p>First we need our filter functions.</p><pre><code class="language-julia hljs"># This tells us the bottom percentile we need to eliminate at each iteration so we have at most `x %` of the original stocks after `n` steps.
percentile_after_n(x, n) = 1 - exp(log(x) / n)

function filter_best(assets, rms, best, cov_type, cor_type)
    # Copy the assets to a vector that will be shrunk at every iteration.
    assets_best = copy(assets)
    # Compute the bottom percentile we need to remove after each iteration.
    q = percentile_after_n(best, length(rms))
    # Loop over all risk measures.
    for rm ∈ rms
        hp = HCPortfolio(; prices = prices[Symbol.(assets_best)])
        asset_statistics!(hp; cov_type = covcor_type, cor_type = covcor_type,
                          set_kurt = false, set_skurt = false, set_mu = false,
                          set_skew = isa(rm, Skew) ? true : false, set_sskew = false)
        cluster_assets!(hp; hclust_opt = HCOpt(; k_method = StdSilhouette()))
        w = optimise!(hp; type = HERC(), rm = rm)

        if isempty(w)
            continue
        end

        w = w.weights

        # Only take the stocks above the q&#39;th quantile at each step.
        qidx = w .&gt;= quantile(w, q)
        assets_best = assets_best[qidx]
    end
    return assets_best
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">filter_best (generic function with 1 method)</code></pre><p>Now we can define the parameters for our filtering procedure.</p><pre><code class="language-julia hljs"># Risk measures.
rms = [SD(), SSD(), CVaR(), CDaR(), Skew()]

# Lets say we want to have 50% of all stocks at the end.
best = 0.5

# Lets use denoised and detoned covariance and correlation types so we can get rid of market forces. We&#39;re using the normal covariance as it&#39;s not very expensive to compute and we&#39;ve made it more robust by denoising and detoning.
covcor_type = PortCovCor(; ce = CovFull(), denoise = DenoiseFixed(; detone = true))

# Filter assets to only have the best ones.
assets_best = filter_best(assets, rms, best, covcor_type, covcor_type)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">11-element Vector{String}:
 &quot;AAPL&quot;
 &quot;DELL&quot;
 &quot;DG&quot;
 &quot;INTC&quot;
 &quot;LULU&quot;
 &quot;MCI&quot;
 &quot;MSFT&quot;
 &quot;NVDA&quot;
 &quot;SBUX&quot;
 &quot;SIRI&quot;
 &quot;STX&quot;</code></pre><p>We can see that we end up with the best 11 stocks.</p><pre><code class="language-julia hljs">assets_best</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">11-element Vector{String}:
 &quot;AAPL&quot;
 &quot;DELL&quot;
 &quot;DG&quot;
 &quot;INTC&quot;
 &quot;LULU&quot;
 &quot;MCI&quot;
 &quot;MSFT&quot;
 &quot;NVDA&quot;
 &quot;SBUX&quot;
 &quot;SIRI&quot;
 &quot;STX&quot;</code></pre><p>We can now use fancier optimisations and statistics with the smaller stock universe.</p><pre><code class="language-julia hljs">hp = HCPortfolio(; prices = prices[Symbol.(assets_best)],
                 # Continuous optimiser.
                 solvers = Dict(:Clarabel1 =&gt; Dict(:solver =&gt; Clarabel.Optimizer,
                                                   :check_sol =&gt; (allow_local = true,
                                                                  allow_almost = true),
                                                   :params =&gt; Dict(&quot;verbose&quot; =&gt; false))),
                 # MIP optimiser for the discrete allocation.
                 alloc_solvers = Dict(:HiGHS =&gt; Dict(:solver =&gt; HiGHS.Optimizer,
                                                     :check_sol =&gt; (allow_local = true,
                                                                    allow_almost = true),
                                                     :params =&gt; Dict(&quot;log_to_console&quot; =&gt; false))))

covcor_type = PortCovCor(; ce = CorGerber1())
mu_type = MuBOP()
asset_statistics!(hp; cov_type = covcor_type, cor_type = covcor_type, mu_type = mu_type,
                  set_kurt = false, set_skurt = false, set_skew = false, set_sskew = false)
cluster_assets!(hp; hclust_opt = HCOpt(; k_method = TwoDiff()))</code></pre><p>We&#39;ll use the nested clustering optimisation. We will also use the maximum risk adjusted return ratio objective function. We will also allocate the portfolio according to our availabe cash and the latest prices.</p><pre><code class="language-julia hljs">w = optimise!(hp; rm = RLDaR(),
              type = NCO(;
                         # Risk adjusted return ratio objective function.
                         opt_kwargs = (; obj = Sharpe(; rf = 3.5 / 100 / 252))))

# Say we have 3000 dollars at our disposal to allocate the portfolio
wa = allocate!(hp; type = :NCO, investment = 3000)

pretty_table(w; formatters = fmt1)
pretty_table(wa; formatters = fmt2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌─────────┬──────────┐
│<span class="sgr1"> tickers </span>│<span class="sgr1">  weights </span>│
│<span class="sgr90">  String </span>│<span class="sgr90">  Float64 </span>│
├─────────┼──────────┤
│    AAPL │    0.0 % │
│    DELL │    0.0 % │
│      DG │  5.706 % │
│    INTC │ 39.187 % │
│    LULU │    0.0 % │
│     MCI │    0.0 % │
│    MSFT │    0.0 % │
│    NVDA │    0.0 % │
│    SBUX │    0.0 % │
│    SIRI │ 55.106 % │
│     STX │    0.0 % │
└─────────┴──────────┘
┌─────────┬────────┬─────────┬─────────┬─────────┐
│<span class="sgr1"> tickers </span>│<span class="sgr1"> shares </span>│<span class="sgr1">   price </span>│<span class="sgr1">    cost </span>│<span class="sgr1"> weights </span>│
│<span class="sgr90">  String </span>│<span class="sgr90">  Int64 </span>│<span class="sgr90"> Float64 </span>│<span class="sgr90"> Float64 </span>│<span class="sgr90"> Float64 </span>│
├─────────┼────────┼─────────┼─────────┼─────────┤
│    AAPL │      0 │ 128.719 │     0.0 │   0.0 % │
│    DELL │      0 │ 38.4654 │     0.0 │   0.0 % │
│      DG │      1 │ 238.623 │ 238.623 │ 7.954 % │
│    INTC │     43 │ 25.4859 │ 1095.89 │ 36.53 % │
│    LULU │      0 │  320.38 │     0.0 │   0.0 % │
│     MCI │      1 │ 12.2062 │ 12.2062 │ 0.407 % │
│    MSFT │      0 │  236.42 │     0.0 │   0.0 % │
│    NVDA │      0 │ 14.6044 │     0.0 │   0.0 % │
│    SBUX │      0 │ 95.2773 │     0.0 │   0.0 % │
│    SIRI │     29 │ 56.8443 │ 1648.49 │ 54.95 % │
│     STX │      0 │ 49.4078 │     0.0 │   0.0 % │
└─────────┴────────┴─────────┴─────────┴─────────┘</code></pre><p>However, we can do one better, we can take the worst performing stocks as well and short them. Since we&#39;re starting from so few stocks we&#39;ll adjust the best percentage to only take the best 30% after all filters.</p><pre><code class="language-julia hljs">function filter_worst(assets, rms, best, cov_type, cor_type)
    assets_worst = copy(assets)
    # Compute the bottom percentile we need to remove after each iteration.
    q = percentile_after_n(best, length(rms))
    # Loop over all risk measures.
    for rm ∈ rms
        hp = HCPortfolio(; prices = prices[Symbol.(assets_worst)])
        asset_statistics!(hp; cov_type = covcor_type, cor_type = covcor_type,
                          set_kurt = false, set_skurt = false, set_mu = false,
                          set_skew = isa(rm, Skew) ? true : false, set_sskew = false)
        cluster_assets!(hp; hclust_opt = HCOpt(; k_method = StdSilhouette()))
        w = optimise!(hp; type = HERC(), rm = rm)

        if isempty(w)
            continue
        end

        w = w.weights

        # Only take the stocks below the (1-q)&#39;th quantile at each step.
        qidx = w .&lt;= quantile(w, 1 - q)
        assets_worst = assets_worst[qidx]
    end
    return assets_worst
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">filter_worst (generic function with 1 method)</code></pre><p>Now we can define the parameters for our filtering procedures.</p><pre><code class="language-julia hljs"># Risk measures.
rms = [SD(), SSD(), CVaR(), CDaR(), Skew()]

# Lets say we want to have 50% of all stocks at the end, 30% of the best, and 20% of the worst.
best = 0.3
worst = 0.2

# Lets use denoised and detoned covariance and correlation types so we can get rid of market forces. We&#39;re using the normal covariance as it&#39;s not very expensive to compute and we&#39;ve made it more robust by denoising and detoning.
covcor_type = PortCovCor(; ce = CovFull(), denoise = DenoiseFixed(; detone = true))

# Filter assets to only have the best ones.
assets_best = filter_best(assets, rms, best, covcor_type, covcor_type)

# Filter assets to only have the worst ones.
assets_worst = filter_worst(assets, rms, worst, covcor_type, covcor_type)

# Lets join the best and worst tickers into a single vector.
assets_best_worst = union(assets_best, assets_worst)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">11-element Vector{String}:
 &quot;AAPL&quot;
 &quot;DG&quot;
 &quot;MCI&quot;
 &quot;MSFT&quot;
 &quot;SBUX&quot;
 &quot;SIRI&quot;
 &quot;TSLA&quot;
 &quot;NVAX&quot;
 &quot;PARA&quot;
 &quot;SAVE&quot;
 &quot;TLRY&quot;</code></pre><p>This time we&#39;ll make a market neutral portfolio using the NCO optimisation type.</p><pre><code class="language-julia hljs">hp = HCPortfolio(; prices = prices[Symbol.(assets_best_worst)],
                 # Continuous optimiser.
                 solvers = Dict(:Clarabel1 =&gt; Dict(:solver =&gt; Clarabel.Optimizer,
                                                   :check_sol =&gt; (allow_local = true,
                                                                  allow_almost = true),
                                                   :params =&gt; Dict(&quot;verbose&quot; =&gt; false))),
                 # MIP optimiser for the discrete allocation.
                 alloc_solvers = Dict(:HiGHS =&gt; Dict(:solver =&gt; HiGHS.Optimizer,
                                                     :check_sol =&gt; (allow_local = true,
                                                                    allow_almost = true),
                                                     :params =&gt; Dict(&quot;log_to_console&quot; =&gt; false))))

covcor_type = PortCovCor(; ce = CorGerber1())
mu_type = MuBOP()
asset_statistics!(hp; cov_type = covcor_type, cor_type = covcor_type, mu_type = mu_type,
                  set_kurt = false, set_skurt = false, set_skew = false, set_sskew = false)
cluster_assets!(hp; hclust_opt = hclust_opt = HCOpt(; k_method = TwoDiff()))</code></pre><p>For this we need to use the max ret objective and set the appropriate bounds on the asset weights.</p><pre><code class="language-julia hljs"># We need to set w_min and w_max weight constraints of the hierarchical clustering portfolio so the weights can be negative.
hp.w_min = -1
hp.w_max = 1

# The short parameters for the portfolios optimised via NCO.
short = true

# Absolute value of the sum of the short weights.
short_budget = 1

# Sum of all the portfolio weights.
budget = 0

# Upper bound for the value of each short weight.
short_u = 1

# Upper bound for the value of each long weight.
long_u = 1

w = optimise!(hp; rm = RLDaR(),
              type = NCO(;
                         # Allow shorting in the sub portfolios, as well as the synthetic portfolio optimised by NCO.
                         # We also set the the values of `short_u` and `long_u` to be equal to 1.
                         port_kwargs = (; short = short, budget = budget,
                                        short_budget = short_budget, long_u = long_u,
                                        short_u = short_u),
                         # Max return objective.
                         opt_kwargs = (; obj = MaxRet())
                         #
                         )
              #
              )

wa = allocate!(hp; type = :NCO, investment = 3000, short = short, budget = budget,
               short_budget = short_budget)

pretty_table(w; formatters = fmt1)
pretty_table(wa; formatters = fmt2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌─────────┬───────────┐
│<span class="sgr1"> tickers </span>│<span class="sgr1">   weights </span>│
│<span class="sgr90">  String </span>│<span class="sgr90">   Float64 </span>│
├─────────┼───────────┤
│    AAPL │  99.982 % │
│      DG │     0.0 % │
│     MCI │   0.001 % │
│    MSFT │   0.001 % │
│    SBUX │   0.005 % │
│    SIRI │ -99.989 % │
│    TSLA │ -99.972 % │
│    NVAX │   0.002 % │
│    PARA │   0.017 % │
│    SAVE │   0.006 % │
│    TLRY │  99.947 % │
└─────────┴───────────┘
┌─────────┬────────┬──────────┬──────────┬───────────┐
│<span class="sgr1"> tickers </span>│<span class="sgr1"> shares </span>│<span class="sgr1">    price </span>│<span class="sgr1">     cost </span>│<span class="sgr1">   weights </span>│
│<span class="sgr90">  String </span>│<span class="sgr90">  Int64 </span>│<span class="sgr90">  Float64 </span>│<span class="sgr90">  Float64 </span>│<span class="sgr90">   Float64 </span>│
├─────────┼────────┼──────────┼──────────┼───────────┤
│    AAPL │     12 │  128.719 │  1544.63 │  51.488 % │
│      DG │      0 │  238.623 │      0.0 │     0.0 % │
│     MCI │      0 │  12.2062 │      0.0 │     0.0 % │
│    MSFT │      0 │   236.42 │      0.0 │     0.0 % │
│    SBUX │      0 │  95.2773 │      0.0 │     0.0 % │
│    SIRI │    -26 │ -56.8443 │ -1477.95 │ -49.265 % │
│    TSLA │    -12 │  -123.18 │ -1478.16 │ -49.272 % │
│    NVAX │      0 │    10.28 │      0.0 │     0.0 % │
│    PARA │      0 │  16.2832 │      0.0 │     0.0 % │
│    SAVE │      0 │   17.628 │      0.0 │     0.0 % │
│    TLRY │    541 │     2.69 │  1455.29 │   48.51 % │
└─────────┴────────┴──────────┴──────────┴───────────┘</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../1_basic_use/">Example 1: Basic use »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Wednesday 23 October 2024 22:26">Wednesday 23 October 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
